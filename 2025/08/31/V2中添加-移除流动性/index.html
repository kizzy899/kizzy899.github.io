<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>V2中添加/移除流动性&amp;无常损失 | EIGHTJIU</title><meta name="author" content="kizy"><meta name="copyright" content="kizy"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="前置文章: https:&#x2F;&#x2F;kizzy899.github.io&#x2F;2025&#x2F;08&#x2F;06&#x2F;Uniswap%E4%B8%93%E9%A1%B9&#x2F;    项目代码: https:&#x2F;&#x2F;github.com&#x2F;Uniswap&#x2F;v2-core&#x2F;blob&#x2F;master&#x2F;contracts&#x2F;UniswapV2Pair.sol  添加流动性 在 Router.addLiquidity() 流程中：  Router">
<meta property="og:type" content="article">
<meta property="og:title" content="V2中添加&#x2F;移除流动性&amp;无常损失">
<meta property="og:url" content="https://kizzy899.github.io/2025/08/31/V2%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7/index.html">
<meta property="og:site_name" content="EIGHTJIU">
<meta property="og:description" content="前置文章: https:&#x2F;&#x2F;kizzy899.github.io&#x2F;2025&#x2F;08&#x2F;06&#x2F;Uniswap%E4%B8%93%E9%A1%B9&#x2F;    项目代码: https:&#x2F;&#x2F;github.com&#x2F;Uniswap&#x2F;v2-core&#x2F;blob&#x2F;master&#x2F;contracts&#x2F;UniswapV2Pair.sol  添加流动性 在 Router.addLiquidity() 流程中：  Router">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://kizzy899.github.io/cover/cover_10.jpg">
<meta property="article:published_time" content="2025-08-31T07:45:50.000Z">
<meta property="article:modified_time" content="2025-09-01T09:17:23.342Z">
<meta property="article:author" content="kizy">
<meta property="article:tag" content="Uniswap">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://kizzy899.github.io/cover/cover_10.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "V2中添加/移除流动性&无常损失",
  "url": "https://kizzy899.github.io/2025/08/31/V2%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7/",
  "image": "https://kizzy899.github.io/cover/cover_10.jpg",
  "datePublished": "2025-08-31T07:45:50.000Z",
  "dateModified": "2025-09-01T09:17:23.342Z",
  "author": [
    {
      "@type": "Person",
      "name": "kizy",
      "url": "https://kizzy899.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/tubiao.png"><link rel="canonical" href="https://kizzy899.github.io/2025/08/31/V2%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'V2中添加/移除流动性&无常损失',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/_custom/custom.css"><meta name="generator" content="Hexo 7.3.0"></head><body><div id="web_bg" style="background-image: url(/img/aaaset/page.jpg);"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/aaaset/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/search/"><i class="fa-fw fas fa-search"></i><span> Search</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> link</span></a></li><li><a class="site-page child" href="/star/"><i class="fa-fw fas fa-star"></i><span> star</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(/cover/cover_10.jpg);"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">EIGHTJIU</span></a><a class="nav-page-title" href="/"><span class="site-name">V2中添加/移除流动性&amp;无常损失</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/search/"><i class="fa-fw fas fa-search"></i><span> Search</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> link</span></a></li><li><a class="site-page child" href="/star/"><i class="fa-fw fas fa-star"></i><span> star</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">V2中添加/移除流动性&amp;无常损失</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-08-31T07:45:50.000Z" title="发表于 2025-08-31 15:45:50">2025-08-31</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-09-01T09:17:23.342Z" title="更新于 2025-09-01 17:17:23">2025-09-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><blockquote>
<p> 前置文章: <a href="https://kizzy899.github.io/2025/08/06/Uniswap%E4%B8%93%E9%A1%B9/">https://kizzy899.github.io/2025/08/06/Uniswap%E4%B8%93%E9%A1%B9/</a></p>
</blockquote>
<blockquote>
<p> 项目代码: <a target="_blank" rel="noopener" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol">https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Pair.sol</a></p>
</blockquote>
<h1 id="添加流动性"><a href="#添加流动性" class="headerlink" title="添加流动性"></a>添加流动性</h1><p><img src="https://s2.loli.net/2025/09/01/JUKSyMEVls7GI4e.png" alt="image.png"></p>
<p>在 <strong>Router.addLiquidity()</strong> 流程中：</p>
<ol>
<li>Router 会先调用 <code>Factory.getPair(tokenA, tokenB)</code> 检查池子是否存在</li>
</ol>
<blockquote>
<p><code>getPair[token0][token1]</code> 用来查询该交易对是否已经存在 Pair 合约。</p>
<p>如果返回 <strong>非零地址</strong>，说明这个交易对已经有 Pair 了 → **不会再调用 <code>create2</code>**。</p>
<p>如果返回 <strong>零地址</strong>，才会用 <code>create2</code> 部署新的 Pair 合约，并初始化。</p>
</blockquote>
<ol start="2">
<li><p>如果不存在 → <code>Factory.createPair(tokenA, tokenB)</code> 创建一个新的 Pair 合约</p>
</li>
<li><p>然后 Router 才把用户代币转到 Pair 并调用 <code>mint()</code></p>
</li>
</ol>
<blockquote>
<p>mint() : 把用户添加到池子里的代币，转换成 LP Token（流动性份额）并分发给用户</p>
</blockquote>
<h2 id="代码设计"><a href="#代码设计" class="headerlink" title="代码设计"></a>代码设计</h2><ol>
<li>代码中还有一个变量：<code>MIMIMUM.LIQUIDITY</code></li>
</ol>
<p>作用：</p>
<p><strong>防止除零错误 防止价格操纵  提高安全性  维持价格稳定</strong></p>
<hr>
<blockquote>
<p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Factory.sol">https://github.com/Uniswap/v2-core/blob/master/contracts/UniswapV2Factory.sol</a></p>
</blockquote>
<p>2.<code>getPair[token0][token1]``getPair[token0][token1]</code> 有一个对<code>token0</code>和<code>token1</code>的排序（小的放前面）</p>
<p>作用：</p>
<p><strong>避免顺序不一样带来两种结果</strong></p>
<hr>
<ol start="3">
<li>为什么要使用<code>create2( )</code>来创建<code>pair</code></li>
</ol>
<p>作用：</p>
<p><strong>在执行之后直接拿到<code>pair</code>的地址  无需等交易上链</strong></p>
<hr>
<h1 id="移除流动性"><a href="#移除流动性" class="headerlink" title="移除流动性"></a><strong>移除流动性</strong></h1><blockquote>
<p>项目代码： <a target="_blank" rel="noopener" href="https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol">https://github.com/Uniswap/v2-periphery/blob/master/contracts/UniswapV2Router02.sol</a></p>
</blockquote>
<p>代码中的参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">address tokenA,</span><br><span class="line">     address tokenB,</span><br><span class="line">     uint liquidity,//需要移除多少</span><br><span class="line">     uint amountAMin,</span><br><span class="line">     uint amountBMin,</span><br><span class="line">     address to,</span><br><span class="line">     uint deadline</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2025/08/31/LTZanSy9okCE6XJ.png" alt="image.png"></p>
<h2 id="代码设计-1"><a href="#代码设计-1" class="headerlink" title="代码设计"></a>代码设计</h2><p><code>.burn( )</code>:当用户 <strong>移除流动性</strong> 时调用，销毁 LP Token，并把底层资产返还给用户</p>
<blockquote>
<p>与添加流动性中的<code>mint()</code>作用相对</p>
</blockquote>
<p><code>uint liquidity = balanceOf[address(this)];</code></p>
<ul>
<li><code>balanceOf</code> 映射记录了 <strong>每个地址持有的 LP Token 数量</strong></li>
<li><code>address(this)</code> 指的是 <strong>当前 Pair 合约自己的地址</strong></li>
</ul>
<p>👉 <code>balanceOf[address(this)]</code> &#x3D; <strong>Pair 合约自己持有的 LP Token 数量</strong></p>
<h1 id="原理解释笔记"><a href="#原理解释笔记" class="headerlink" title="原理解释笔记"></a>原理解释笔记</h1><p><img src="https://s2.loli.net/2025/08/31/w7N13XRQxEFqvrk.jpg" alt="690548c35aebcd747983ef23819e119f.jpg"></p>
<h1 id="无常损失"><a href="#无常损失" class="headerlink" title="无常损失"></a>无常损失</h1><p><strong>为什么要提供手续费给LP</strong></p>
<ol>
<li><p>交易所用于吸引别人来做LP</p>
</li>
<li><p>弥补无常损失</p>
</li>
</ol>
<h2 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h2><p>对以下手写笔记中第一、二点的解释：</p>
<p><strong>为什么做 LP（持 LP Token）和单纯持币（HODL）结果不同</strong>，以及公式为什么看起来不一样。<br> 我们拆开来看：</p>
<hr>
<h3 id="🔹-1-初始情况"><a href="#🔹-1-初始情况" class="headerlink" title="🔹 1. 初始情况"></a>🔹 1. 初始情况</h3><ul>
<li>池子最初：<code>100 A + 1 B</code></li>
<li>价格：<code>1 B = 100 A</code></li>
<li>总价值：<code>200 A</code></li>
</ul>
<p>假设你作为唯一 LP，把资金都放进池子，获得池子 100% 的份额（LPT）。</p>
<hr>
<h3 id="🔹-2-价格变化后"><a href="#🔹-2-价格变化后" class="headerlink" title="🔹 2. 价格变化后"></a>🔹 2. 价格变化后</h3><p>价格变了：</p>
<ul>
<li>新价格 <code>1 B ≈ 120 A</code>（也就是 A 涨价了）</li>
<li>或者换个写法：<code>k = 120 * 0.83</code>（也就是池子自动调整后，储备可能是 <code>120 A + 0.83 B</code>）</li>
</ul>
<p>这时候有两种策略：</p>
<hr>
<h3 id="🔹-3-不做-LP（HODL-策略）"><a href="#🔹-3-不做-LP（HODL-策略）" class="headerlink" title="🔹 3. 不做 LP（HODL 策略）"></a>🔹 3. <strong>不做 LP（HODL 策略）</strong></h3><p>初始你是 <strong>100 A + 1 B</strong>。<br> 涨价后：</p>
<ul>
<li>1 B 的价值 &#x3D; <code>120 A</code></li>
<li>你总价值 &#x3D; <code>100 A + 1 B × 120 A = 100 A + 120 A = 220 A</code></li>
</ul>
<p>但你提到结果是 <strong>244.58 A</strong>，这里其实对应的是你如果 <strong>纯粹 HODL B</strong>（因为 B 涨了），再折算的结果。</p>
<p>👉 公式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">不做 LP = 1 * (120/0.83 + 120)</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<ul>
<li><code>120 / 0.83 ≈ 144.58</code> 表示 1 B 现在相当于多少 A</li>
<li>再加上手里原来那部分 A (<code>120</code>)</li>
<li>所以得到 244.58 A</li>
</ul>
<hr>
<h3 id="🔹-4-做-LP（提供流动性）"><a href="#🔹-4-做-LP（提供流动性）" class="headerlink" title="🔹 4. 做 LP（提供流动性）"></a>🔹 4. <strong>做 LP（提供流动性）</strong></h3><p>作为 LP，你的资产在价格变动时会 <strong>被动再平衡</strong>，变成 <code>120 A + 0.83 B</code>。<br> 也就是说：</p>
<ul>
<li>你不再是单纯拿 <code>100 A + 1 B</code></li>
<li>而是池子帮你“自动再配置”到新比例</li>
</ul>
<p>👉 公式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">做 LP = 0.83 * (120 / 0.83) + 120</span><br></pre></td></tr></table></figure>

<p>解释：</p>
<ul>
<li><code>0.83 B</code> 折算成 A：<code>0.83 * (120 / 0.83) = 120 A</code></li>
<li>加上池子里那部分 120 A</li>
<li>总计 &#x3D; <code>240 A</code></li>
</ul>
<hr>
<h3 id="🔹-5-差异的原因（核心）"><a href="#🔹-5-差异的原因（核心）" class="headerlink" title="🔹 5. 差异的原因（核心）"></a>🔹 5. 差异的原因（核心）</h3><ul>
<li><strong>不做 LP</strong>：你完全跟随 B 的涨幅（相当于持有单边仓位），因此获得更高的收益 → 244.58 A</li>
<li><strong>做 LP</strong>：池子自动帮你做了「A-B 的平衡配置」，你在 A 涨的时候被动卖掉了一部分 B，所以赚得少 → 240 A</li>
</ul>
<p>这就是著名的 <strong>无常损失（Impermanent Loss, IL）</strong>：</p>
<ul>
<li>相比单纯持有，你少赚了一点</li>
<li>但 LP 有手续费奖励（swap 手续费），这可能会补偿 IL</li>
</ul>
<p><img src="https://s2.loli.net/2025/08/31/By3eQ21iOzlCWGm.jpg" alt="945af99adcc5dd4d5a5643bcad655806.jpg"></p>
<h3 id="IL-d-图像："><a href="#IL-d-图像：" class="headerlink" title="IL(d)图像："></a>IL(d)图像：</h3><p><img src="https://s2.loli.net/2025/08/31/ElrYNOt5yVTejJf.jpg" alt="b893ed55b4dab4bef037f537c98e18aa.jpg"></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://kizzy899.github.io">kizy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://kizzy899.github.io/2025/08/31/V2%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7/">https://kizzy899.github.io/2025/08/31/V2%E4%B8%AD%E6%B7%BB%E5%8A%A0-%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://kizzy899.github.io" target="_blank">EIGHTJIU</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Uniswap/">Uniswap</a></div><div class="post-share"><div class="social-share" data-image="/cover/cover_10.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/09/01/V2%E4%B8%AD%E7%9A%84%E9%97%AA%E7%94%B5%E8%B4%B7%E5%92%8CTWAP/" title="V2中的闪电贷和TWAP"><img class="cover" src="/aaaset/cover_17.jpg" onerror="onerror=null;src='/img/404page.jpg'" alt="cover of previous post"><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">V2中的闪电贷和TWAP</div></div><div class="info-2"><div class="info-item-1">Flash Swap什么是闪电贷闪电贷 是一种 无需抵押的贷款机制，主要出现在 DeFi（去中心化金融）协议里。 它的核心特点是：  用户可以瞬间借到大量资金（几乎没有上限，只受池子流动性限制）。 必须在同一个交易（同一个区块内）还清。 如果没有还清，整个交易会直接被回滚（就像从没发生过一样）。 所以协议提供者不会有风险。    闪电贷有什么用？ 套利 不同交易所（比如 Uniswap、SushiSwap、Curve）之间价格差异，瞬间搬运套利。   清算 在借贷协议（比如 Aave、Compound）里，当有人抵押物不足时，你可以用闪电贷借钱去清算，然后赚取奖励。   抵押物替换 假如你在 MakerDAO 抵押 ETH 借了 DAI，但想换成 WBTC 抵押，可以用闪电贷无缝替换，不需要先卖掉 ETH 再买 BTC。   高杠杆操作 利用瞬时借贷，把本金放大很多倍，进行投机或策略。    为什么 Uniswap V2 也能提供闪电贷？ Uniswap V2 引入了一个机制：你可以拿走池子里的代币，只要在交易结束前归还相同数量的代币（或等值代币）。 这正好可以被用来实现 闪电贷...</div></div></div></a><a class="pagination-related" href="/2025/08/31/UniswapV2%E4%B8%AD%E7%9A%84swap%E6%93%8D%E4%BD%9C%E5%92%8C%E6%89%8B%E7%BB%AD%E8%B4%B9%E6%9C%BA%E5%88%B6/" title="V2中的swap操作和手续费机制"><img class="cover" src="/cover/cover7.jpg" onerror="onerror=null;src='/img/404page.jpg'" alt="cover of next post"><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">V2中的swap操作和手续费机制</div></div><div class="info-2"><div class="info-item-1">Swap操作关于DAI&#x2F;USDT的单交换 逻辑：  Router02.sol   SwapexactTokensForTokens( ) SwapTokensForexactTokens( )   资金转换 transferFrom( ) [ pair DAI&#x2F;USDT]  Swap   transfer(币转给用户)    多Tokens之间的交换此时path参数 1path = [DAI, WBTC, USDC];  流程图：  逻辑：  用户调用 Router02 的 swapExactTokensForTokens，传入 path = [DAI, WBTC, USDC]。  Router02 先把用户的 DAI 转入 DAI-WBTC Pair。  DAI-WBTC Pair 执行 swap，把 WBTC 发给下一个 Pair（由 Router02 转发）。  Router02 把 WBTC 继续送入 WBTC-USDC Pair。  WBTC-USDC Pair 执行 swap，把 USDC 最终发给用户。  用户完成从 DAI → WBTC → U...</div></div></div></a></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><a class="pagination-related" href="/2025/08/06/Uniswap%E4%B8%93%E9%A1%B9/" title="Uniswap专项"><img class="cover" src="/cover/cover_11.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-06</div><div class="info-item-2">Uniswap专项</div></div><div class="info-2"><div class="info-item-1">恒定乘积自动做市商算法核心公式恒定乘积做市商的核心公式是：x * y = k其中：  ( x ) 是第一种资产的数量（如ETH） ( y ) 是第二种资产的数量（如USDT） ( k ) 是常数乘积  价格变动机制当交易发生时，资产数量的变化遵循：[ (x + dx)(y - dy) &#x3D; k ][ (x - dx)(y + dy) &#x3D; k ] 滑点计算滑点计算公式（纯文本格式）滑点(S) &#x3D; [(实际执行价格 - 预期价格) &#x2F; 预期价格] × 100% 变量说明： 滑点(S)：以百分比(%)表示的价格偏差 实际执行价格：交易实际成交的价格 预期价格：交易发起时预期的市场价格  示例：如果预期价格是2000 USDT，实际执行价格是2666.66 USDT，那么：滑点 &#x3D; [(2666.66 - 2000)&#x2F;2000] × 100% &#x3D; 33.33% 公式解读： 先计算实际价格与预期价格的差值 将差值除以预期价格，得到相对偏差 乘以100%转换为百分比形式  注意事项： 正值表示实际价格高于预期（对买方不利） ...</div></div></div></a><a class="pagination-related" href="/2025/08/31/UniswapV2%E4%B8%AD%E7%9A%84swap%E6%93%8D%E4%BD%9C%E5%92%8C%E6%89%8B%E7%BB%AD%E8%B4%B9%E6%9C%BA%E5%88%B6/" title="V2中的swap操作和手续费机制"><img class="cover" src="/cover/cover7.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-31</div><div class="info-item-2">V2中的swap操作和手续费机制</div></div><div class="info-2"><div class="info-item-1">Swap操作关于DAI&#x2F;USDT的单交换 逻辑：  Router02.sol   SwapexactTokensForTokens( ) SwapTokensForexactTokens( )   资金转换 transferFrom( ) [ pair DAI&#x2F;USDT]  Swap   transfer(币转给用户)    多Tokens之间的交换此时path参数 1path = [DAI, WBTC, USDC];  流程图：  逻辑：  用户调用 Router02 的 swapExactTokensForTokens，传入 path = [DAI, WBTC, USDC]。  Router02 先把用户的 DAI 转入 DAI-WBTC Pair。  DAI-WBTC Pair 执行 swap，把 WBTC 发给下一个 Pair（由 Router02 转发）。  Router02 把 WBTC 继续送入 WBTC-USDC Pair。  WBTC-USDC Pair 执行 swap，把 USDC 最终发给用户。  用户完成从 DAI → WBTC → U...</div></div></div></a><a class="pagination-related" href="/2025/08/31/v1-v4%E7%AE%80%E4%BB%8B/" title="Uniswapv1-v4简介"><img class="cover" src="/cover/page2.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-08-31</div><div class="info-item-2">Uniswapv1-v4简介</div></div><div class="info-2"><div class="info-item-1">Uniswap V1 2018年11月2日发布 使用 Vyper 语言编写 仅支持 ERC20-ETH 直接互换或者通过ETH进行互换: 合约地址: Uniswap&#x2F;v1-contracts: Uniswap V1 smartcontracts (github.com)  合约重点：  Exchange——交易逻辑  factory——创建交易对   createchange( )    Uniswap V2 2020年5月发布; 增加 ERC20-ERC20直接互换:。增加 Flash Swap; 增加 Oracle; 改进手续费收取方式; 引爆了 DeFi 赛道; 2020年9月，发行治理代币UNI;   什么是DeFilamaDeFiLlama 是一个 去中心化金融（DeFi）数据聚合平台，主要提供各种区块链 DeFi 协议的统计数据和分析。它的特点是 中立、免费、开源，不像一些由 VC 资助的平台，它更倾向于社区驱动。 DeFiLlama 提供什么功能？ TVL（Total Value Locked）数据 可以看到不同链（以太坊、BSC、Arbitrum、Pol...</div></div></div></a><a class="pagination-related" href="/2025/09/01/V2%E4%B8%AD%E7%9A%84%E9%97%AA%E7%94%B5%E8%B4%B7%E5%92%8CTWAP/" title="V2中的闪电贷和TWAP"><img class="cover" src="/aaaset/cover_17.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-01</div><div class="info-item-2">V2中的闪电贷和TWAP</div></div><div class="info-2"><div class="info-item-1">Flash Swap什么是闪电贷闪电贷 是一种 无需抵押的贷款机制，主要出现在 DeFi（去中心化金融）协议里。 它的核心特点是：  用户可以瞬间借到大量资金（几乎没有上限，只受池子流动性限制）。 必须在同一个交易（同一个区块内）还清。 如果没有还清，整个交易会直接被回滚（就像从没发生过一样）。 所以协议提供者不会有风险。    闪电贷有什么用？ 套利 不同交易所（比如 Uniswap、SushiSwap、Curve）之间价格差异，瞬间搬运套利。   清算 在借贷协议（比如 Aave、Compound）里，当有人抵押物不足时，你可以用闪电贷借钱去清算，然后赚取奖励。   抵押物替换 假如你在 MakerDAO 抵押 ETH 借了 DAI，但想换成 WBTC 抵押，可以用闪电贷无缝替换，不需要先卖掉 ETH 再买 BTC。   高杠杆操作 利用瞬时借贷，把本金放大很多倍，进行投机或策略。    为什么 Uniswap V2 也能提供闪电贷？ Uniswap V2 引入了一个机制：你可以拿走池子里的代币，只要在交易结束前归还相同数量的代币（或等值代币）。 这正好可以被用来实现 闪电贷...</div></div></div></a><a class="pagination-related" href="/2025/09/01/V3%E4%B8%AD%E7%9A%84%E9%9B%86%E4%B8%AD%E6%B5%81%E5%8A%A8%E6%80%A7%E5%92%8C%E6%B5%81%E5%8A%A8%E6%80%A7%E8%AE%A1%E7%AE%97/" title="V3中的集中流动性和流动性计算"><img class="cover" src="/cover/title.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-09-01</div><div class="info-item-2">V3中的集中流动性和流动性计算</div></div><div class="info-2"><div class="info-item-1">集中流动性（Concentrated Liquidity）传统的 AMM 流动性是整个价格曲线连续分布的，而 V3 允许 LP（流动性提供者）把资金集中在某个 价格区间 [P_min, P_max] 内。 1. 背景在 Uniswap V2 中，流动性提供者（LP）是 全价区间流动性 模式：  流动性必须从 0 到 ∞ 的价格范围内均匀分布。 结果是，大部分资本几乎不会被用到（因为实际交易只发生在某个较小的价格区间）。 这导致资本利用率很低。   2. 集中流动性的核心思想集中流动性（Concentrated Liquidity）： 流动性提供者（LP）不再需要把资金放在整个价格区间，而是可以选择 某个价格区间 来提供流动性。 比如：  你可以只在 1000–2000 USDC/ETH 区间提供流动性。 如果 ETH 价格一直在 1500–1800 之间，你的资金就几乎全都在发挥作用。   3. 技术实现Uniswap V3 的做法是：  把价格区间离散化为一系列 ticks（刻度）。 LP 在提交流动性时，要指定一个区间 [tickLower, tickUpper]。 只有当当...</div></div></div></a><a class="pagination-related" href="/2025/11/05/V3%E4%B8%AD%E5%8D%95%E4%BB%B7%E6%A0%BC%E5%8C%BA%E9%97%B4%E5%86%85%E7%9A%84SWAP/" title="V3中单价格区间内的SWAP"><img class="cover" src="/cover/cover_16.jpg" alt="cover"><div class="info text-center"><div class="info-1"><div class="info-item-1"><i class="far fa-calendar-alt fa-fw"></i> 2025-11-05</div><div class="info-item-2">V3中单价格区间内的SWAP</div></div><div class="info-2"><div class="info-item-1">   逻辑流程 ：  用户调用 Router 发起 swap Router 检查授权并转发到 Pool Pool 创建 SwapState Pool 进入 tick-by-tick 的循环 计算当前流动性下可交换的量 判断是否跨 tick 跨 tick 时更新 liquidity 累积手续费 回调向 Router 收取 tokenIn Pool 向用户支付 tokenOut，并更新价格与 tick  1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798991001011021031041051061071081091101111121131141151161171181191201211221231241251261271281291301311321331341...</div></div></div></a></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="giscus-wrap"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info text-center"><div class="avatar-img"><img src="/img/aaaset/touxiang.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info-name">kizy</div><div class="author-info-description">rainbow</div><div class="site-data"><a href="/archives/"><div class="headline">文章</div><div class="length-num">78</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">10</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">0</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/kizzy899"><i class="fab fa-github"></i><span>my github</span></a><div class="card-info-social-icons"><a class="social-icon" href="https://github.com/kizzy899" target="_blank" title="Github"><i class="fab fa-github" style="color: #24292e;"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">Sampre avanti</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">1.</span> <span class="toc-text">添加流动性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1"><span class="toc-number">1.1.</span> <span class="toc-text">代码设计</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A7%BB%E9%99%A4%E6%B5%81%E5%8A%A8%E6%80%A7"><span class="toc-number">2.</span> <span class="toc-text">移除流动性</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E8%AE%BE%E8%AE%A1-1"><span class="toc-number">2.1.</span> <span class="toc-text">代码设计</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8E%9F%E7%90%86%E8%A7%A3%E9%87%8A%E7%AC%94%E8%AE%B0"><span class="toc-number">3.</span> <span class="toc-text">原理解释笔记</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A0%E5%B8%B8%E6%8D%9F%E5%A4%B1"><span class="toc-number">4.</span> <span class="toc-text">无常损失</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BE%E4%BE%8B"><span class="toc-number">4.1.</span> <span class="toc-text">举例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-1-%E5%88%9D%E5%A7%8B%E6%83%85%E5%86%B5"><span class="toc-number">4.1.1.</span> <span class="toc-text">🔹 1. 初始情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-2-%E4%BB%B7%E6%A0%BC%E5%8F%98%E5%8C%96%E5%90%8E"><span class="toc-number">4.1.2.</span> <span class="toc-text">🔹 2. 价格变化后</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-3-%E4%B8%8D%E5%81%9A-LP%EF%BC%88HODL-%E7%AD%96%E7%95%A5%EF%BC%89"><span class="toc-number">4.1.3.</span> <span class="toc-text">🔹 3. 不做 LP（HODL 策略）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-4-%E5%81%9A-LP%EF%BC%88%E6%8F%90%E4%BE%9B%E6%B5%81%E5%8A%A8%E6%80%A7%EF%BC%89"><span class="toc-number">4.1.4.</span> <span class="toc-text">🔹 4. 做 LP（提供流动性）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%F0%9F%94%B9-5-%E5%B7%AE%E5%BC%82%E7%9A%84%E5%8E%9F%E5%9B%A0%EF%BC%88%E6%A0%B8%E5%BF%83%EF%BC%89"><span class="toc-number">4.1.5.</span> <span class="toc-text">🔹 5. 差异的原因（核心）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IL-d-%E5%9B%BE%E5%83%8F%EF%BC%9A"><span class="toc-number">4.1.6.</span> <span class="toc-text">IL(d)图像：</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/img/aaaset/title.png);"><div class="footer-other"><div class="footer-copyright"></div><div class="footer_custom_text">-899</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="前往评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const isShuoshuo = GLOBAL_CONFIG_SITE.pageType === 'shuoshuo'
  const option = null

  const getGiscusTheme = theme => theme === 'dark' ? 'dark' : 'light'

  const createScriptElement = config => {
    const ele = document.createElement('script')
    Object.entries(config).forEach(([key, value]) => {
      ele.setAttribute(key, value)
    })
    return ele
  }

  const loadGiscus = (el = document, key) => {
    const mappingConfig = isShuoshuo
      ? { 'data-mapping': 'specific', 'data-term': key }
      : { 'data-mapping': (option && option['data-mapping']) || 'pathname' }

    const giscusConfig = {
      src: 'https://giscus.app/client.js',
      'data-repo': 'kizzy899/kizzy899.github.io',
      'data-repo-id': 'R_kgDONCC1iQ',
      'data-category-id': 'DIC_kwDONCC1ic4CtwTu',
      'data-theme': getGiscusTheme(document.documentElement.getAttribute('data-theme')),
      'data-reactions-enabled': '1',
      crossorigin: 'anonymous',
      async: true,
      ...option,
      ...mappingConfig
    }

    const scriptElement = createScriptElement(giscusConfig)

    el.querySelector('#giscus-wrap').appendChild(scriptElement)

    if (isShuoshuo) {
      window.shuoshuoComment.destroyGiscus = () => {
        if (el.children.length) {
          el.innerHTML = ''
          el.classList.add('no-comment')
        }
      }
    }
  }

  const changeGiscusTheme = theme => {
    const iframe = document.querySelector('#giscus-wrap iframe')
    if (iframe) {
      const message = {
        giscus: {
          setConfig: {
            theme: getGiscusTheme(theme)
          }
        }
      }
      iframe.contentWindow.postMessage(message, 'https://giscus.app')
    }
  }

  btf.addGlobalFn('themeChange', changeGiscusTheme, 'giscus')

  if (isShuoshuo) {
    'Giscus' === 'Giscus'
      ? window.shuoshuoComment = { loadComment: loadGiscus }
      : window.loadOtherComment = loadGiscus
    return
  }

  if ('Giscus' === 'Giscus' || !false) {
    if (false) btf.loadComment(document.getElementById('giscus-wrap'), loadGiscus)
    else loadGiscus()
  } else {
    window.loadOtherComment = loadGiscus
  }
})()</script></div><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/click-show-text.min.js" data-mobile="false" data-text="8,9,小,金" data-fontsize="15px" data-random="false" async="async"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>